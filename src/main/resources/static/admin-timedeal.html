<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íƒ€ì„ë”œ ê´€ë¦¬ - ì‹¹ì“°ë¦¬ ê´€ë¦¬ì</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Apple SD Gothic Neo', sans-serif;
            background: #fafafa;
            min-height: 100vh;
        }

        /* â”€â”€ í—¤ë” â”€â”€ */
        header {
            background: #ffffff;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #f0f0f0;
        }

        .logo {
            font-size: 26px;
            font-weight: 700;
            background: linear-gradient(135deg, #74b9ff 0%, #a29bfe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            cursor: pointer;
        }

        .header-title {
            flex: 1;
            font-size: 20px;
            font-weight: 600;
            color: #212529;
        }

        .header-icons {
            display: flex;
            gap: 12px;
        }

        .btn-common {
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: 0.2s;
        }

        .home-btn {
            background: linear-gradient(135deg, #74b9ff 0%, #a29bfe 100%);
            color: white;
        }

        .home-btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .logout-btn {
            background: #f8f9fa;
            color: #495057;
        }

        .logout-btn:hover {
            background: #e9ecef;
        }

        /* â”€â”€ í˜ì´ì§€ ì»¨í…Œì´ë„ˆ â”€â”€ */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .page-header {
            background: linear-gradient(135deg, #fd79a8 0%, #e17055 100%);
            padding: 40px;
            border-radius: 24px;
            margin-bottom: 40px;
            color: white;
            box-shadow: 0 10px 40px rgba(253, 121, 168, 0.25);
        }

        .page-header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .page-header p {
            font-size: 15px;
            opacity: 0.9;
        }

        /* â”€â”€ íƒ­ â”€â”€ */
        .tab-section {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .tab-btn {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            background: white;
            color: #495057;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: 0.2s;
        }

        .tab-btn.active {
            background: #fd79a8;
            color: white;
        }

        .tab-btn:not(.active):hover {
            background: #f8f9fa;
        }

        /* â”€â”€ íˆ´ë°” â”€â”€ */
        .toolbar {
            background: white;
            padding: 20px 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .toolbar-spacer {
            flex: 1;
        }

        .create-btn {
            background: #fd79a8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
        }

        .create-btn:hover {
            background: #e66895;
            transform: translateY(-1px);
        }

        /* â”€â”€ ìƒíƒœ í•„í„° ì¹© â”€â”€ */
        .status-filter-group {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-chip {
            padding: 6px 14px;
            border-radius: 20px;
            border: 2px solid #e9ecef;
            background: white;
            color: #495057;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.15s;
        }

        .status-chip:hover {
            border-color: #fd79a8;
            color: #fd79a8;
        }

        .status-chip.active {
            background: #fd79a8;
            color: white;
            border-color: #fd79a8;
        }

        /* â”€â”€ í…Œì´ë¸” â”€â”€ */
        .table-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8f9fa;
            padding: 16px 20px;
            text-align: left;
            font-size: 13px;
            color: #495057;
            border-bottom: 1px solid #e9ecef;
            white-space: nowrap;
        }

        td {
            padding: 16px 20px;
            font-size: 14px;
            color: #495057;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }

        tr:hover td {
            background: #fff5f8;
        }

        tbody tr {
            cursor: pointer;
        }

        /* â”€â”€ íƒ€ì„ë”œ ìƒíƒœ ë°°ì§€ â”€â”€ */
        .badge {
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            white-space: nowrap;
            display: inline-block;
        }

        .badge-active {
            background: #e3f2fd;
            color: #1565c0;
        }

        .badge-upcoming {
            background: #f3e5f5;
            color: #6a1b9a;
        }

        .badge-ended {
            background: #f5f5f5;
            color: #757575;
        }

        /* í• ì¸ìœ¨ ê°•ì¡° */
        .discount-rate {
            font-weight: 700;
            color: #e74c3c;
            font-size: 15px;
        }

        .original-price {
            text-decoration: line-through;
            color: #adb5bd;
            font-size: 12px;
        }

        /* â”€â”€ í˜ì´ì§€ë„¤ì´ì…˜ â”€â”€ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 24px;
            gap: 6px;
            flex-wrap: wrap;
        }

        .page-btn {
            min-width: 36px;
            height: 36px;
            padding: 0 10px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            cursor: pointer;
            background: #fff;
            color: #495057;
            font-size: 13px;
            font-weight: 500;
            transition: 0.15s;
        }

        .page-btn:hover {
            background: #fff0f5;
            border-color: #fd79a8;
        }

        .page-btn.active {
            background: #fd79a8;
            color: white;
            border-color: #fd79a8;
            font-weight: 700;
        }

        .page-btn.nav {
            font-weight: 700;
            color: #fd79a8;
        }

        /* â”€â”€ ê³µí†µ ëª¨ë‹¬ â”€â”€ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 32px;
            width: 90%;
            max-width: 620px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #212529;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-row {
            display: flex;
            gap: 16px;
        }

        .form-row .form-group {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #495057;
        }

        .required-mark {
            color: #e74c3c;
        }

        input[type="text"], input[type="number"], input[type="datetime-local"], select, textarea {
            width: 100%;
            padding: 11px 14px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.15s;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #fd79a8;
        }

        /* ìƒí’ˆ ê²€ìƒ‰ ë“œë¡­ë‹¤ìš´ */
        .product-search-wrap {
            position: relative;
        }

        .product-search-input {
            cursor: text;
        }

        .product-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #fd79a8;
            border-radius: 12px;
            max-height: 220px;
            overflow-y: auto;
            z-index: 200;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        .product-dropdown.open {
            display: block;
        }

        .product-option {
            padding: 10px 14px;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .product-option:last-child {
            border-bottom: none;
        }

        .product-option:hover {
            background: #fff0f5;
        }

        .product-option img {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            object-fit: cover;
        }

        .product-option .prod-name {
            font-weight: 600;
            color: #212529;
        }

        .product-option .prod-price {
            font-size: 12px;
            color: #adb5bd;
        }

        /* ì„ íƒëœ ìƒí’ˆ ì¹´ë“œ */
        .selected-product-card {
            display: none;
            background: #fff0f5;
            border: 2px solid #fd79a8;
            border-radius: 12px;
            padding: 12px 16px;
            margin-top: 8px;
            align-items: center;
            gap: 12px;
        }

        .selected-product-card.show {
            display: flex;
        }

        .selected-product-card img {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
        }

        .selected-product-info {
            flex: 1;
        }

        .selected-product-info .name {
            font-weight: 700;
            font-size: 14px;
            color: #212529;
        }

        .selected-product-info .price {
            font-size: 12px;
            color: #636e72;
            margin-top: 2px;
        }

        .clear-selection {
            background: none;
            border: none;
            cursor: pointer;
            color: #adb5bd;
            font-size: 18px;
            padding: 4px;
        }

        .clear-selection:hover {
            color: #e74c3c;
        }

        /* íŒíŠ¸ í…ìŠ¤íŠ¸ */
        .hint {
            font-size: 12px;
            color: #adb5bd;
            margin-top: 4px;
        }

        /* ëª¨ë‹¬ í‘¸í„° */
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 28px;
        }

        .delete-btn {
            background: #e74c3c !important;
            color: white !important;
            margin-right: auto;
        }

        .delete-btn:hover {
            background: #c0392b !important;
        }

        .empty-row td {
            text-align: center;
            padding: 60px;
            color: #adb5bd;
        }

        /* â”€â”€ íƒ€ì„ë”œ ì¹´ë“œ ë·° (ì†Œí˜• íƒ€ì„ë¼ì¸) â”€â”€ */
        .time-progress-bar {
            height: 4px;
            border-radius: 2px;
            background: #e9ecef;
            margin-top: 6px;
            overflow: hidden;
        }

        .time-progress-fill {
            height: 100%;
            border-radius: 2px;
            background: linear-gradient(90deg, #fd79a8, #e17055);
            transition: width 0.3s;
        }

        footer {
            background: #212529;
            color: #adb5bd;
            text-align: center;
            padding: 40px 20px;
            margin-top: 60px;
        }

        footer p {
            margin: 10px 0;
            font-size: 14px;
            line-height: 1.6;
        }

        footer p:first-child {
            color: white;
            font-weight: 600;
            font-size: 15px;
        }
    </style>
</head>
<body>

<header>
    <div class="logo" onclick="location.href='home.html'">SSAK3</div>
    <div class="header-icons">
        <button class="btn-common home-btn" id="myPageBtn" onclick="location.href='mypage.html'">ë§ˆì´í˜ì´ì§€</button>
        <button class="btn-common logout-btn" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
</header>

<div class="container">
    <div class="page-header">
        <h1>âš¡ íƒ€ì„ë”œ ë°ì´í„° ê´€ë¦¬</h1>
        <p id="totalCountDisplay">ì „ì²´ íƒ€ì„ë”œ 0ê°œ | í•œì‹œì  í• ì¸ ì´ë²¤íŠ¸ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</p>
    </div>

    <!-- íƒ­ -->
    <div class="tab-section">
        <button class="tab-btn" onclick="location.href='admin-product.html'">ğŸ“¦ ìƒí’ˆ ê´€ë¦¬</button>
        <button class="tab-btn active">âš¡ íƒ€ì„ë”œ ê´€ë¦¬</button>
    </div>

    <!-- íˆ´ë°” -->
    <div class="toolbar">
        <div class="status-filter-group">
            <span style="font-size:13px; font-weight:600; color:#495057; white-space:nowrap;">ìƒíƒœ í•„í„°</span>
            <button class="status-chip active" data-filter="all" onclick="setFilter('all',  this)">ì „ì²´</button>
            <button class="status-chip" data-filter="ready" onclick="setFilter('ready', this)">ì˜ˆì •</button>
            <button class="status-chip" data-filter="open" onclick="setFilter('open', this)">ì§„í–‰ì¤‘</button>
            <button class="status-chip" data-filter="closed" onclick="setFilter('closed', this)">ì¢…ë£Œ</button>
        </div>
        <div class="toolbar-spacer"></div>
        <button class="create-btn" onclick="openCreateModal()">+ íƒ€ì„ë”œ ë“±ë¡</button>
    </div>

    <!-- í…Œì´ë¸” -->
    <div class="table-container">
        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>ìƒí’ˆ ì •ë³´</th>
                <th>ì›ê°€ / ë”œê°€</th>
                <th>í• ì¸ìœ¨</th>
                <th>ì‹œì‘ ì‹œê°„</th>
                <th>ì¢…ë£Œ ì‹œê°„</th>
                <th>ìƒíƒœ</th>
                <th>ë“±ë¡ì¼</th>
            </tr>
            </thead>
            <tbody id="timeDealTableBody">
            <tr class="empty-row">
                <td colspan="8">ë¡œë”© ì¤‘...</td>
            </tr>
            </tbody>
        </table>
        <div id="pagination" class="pagination"></div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     íƒ€ì„ë”œ ë“±ë¡ ëª¨ë‹¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal" id="createModal">
    <div class="modal-content">
        <div class="modal-title">âš¡ íƒ€ì„ë”œ ë“±ë¡</div>

        <!-- ìƒí’ˆ ì„ íƒ -->
        <div class="form-group">
            <label>ìƒí’ˆ ì„ íƒ <span class="required-mark">*</span></label>
            <div class="product-search-wrap">
                <input type="text" id="createProductSearch" class="product-search-input"
                       placeholder="ìƒí’ˆëª… ë˜ëŠ” IDë¡œ ê²€ìƒ‰..."
                       autocomplete="off"
                       oninput="searchProducts(this.value, 'createProductDropdown')"
                       onfocus="if(this.value) searchProducts(this.value, 'createProductDropdown')">
                <div class="product-dropdown" id="createProductDropdown"></div>
            </div>
            <div class="selected-product-card" id="createSelectedCard">
                <img id="createSelectedImg" src="" alt="" onerror="this.style.display='none'">
                <div class="selected-product-info">
                    <div class="name" id="createSelectedName"></div>
                    <div class="price" id="createSelectedPrice"></div>
                </div>
                <button class="clear-selection" onclick="clearProductSelection('create')">âœ•</button>
            </div>
            <input type="hidden" id="createProductId">
        </div>

        <!-- ë”œ ê°€ê²© -->
        <div class="form-group">
            <label>ë”œ ê°€ê²© (ì›) <span class="required-mark">*</span></label>
            <input type="number" id="createDealPrice" placeholder="0" min="1">
            <div class="hint" id="createDiscountHint"></div>
        </div>

        <!-- ì‹œê°„ -->
        <div class="form-row">
            <div class="form-group">
                <label>ì‹œì‘ ì‹œê°„ <span class="required-mark">*</span></label>
                <input type="datetime-local" id="createStartAt">
                <div class="hint">ë¶„ ë‹¨ìœ„ëŠ” ë¬´ì‹œë©ë‹ˆë‹¤ (ì‹œ ê¸°ì¤€ìœ¼ë¡œ ì „ì†¡)</div>
            </div>
            <div class="form-group">
                <label>ì¢…ë£Œ ì‹œê°„ <span class="required-mark">*</span></label>
                <input type="datetime-local" id="createEndAt">
            </div>
        </div>

        <!-- ì´ë¯¸ì§€ -->
        <div class="form-group">
            <label>ëŒ€í‘œ ì´ë¯¸ì§€ URL <span style="font-weight:400; color:#adb5bd">(ì„ íƒ)</span></label>
            <input type="file" id="createImageFile" accept="image/*">
            <input type="hidden" id="createImageUrl">
            <div class="hint">ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ë©´ ìë™ ì—…ë¡œë“œë©ë‹ˆë‹¤.</div>
        </div>
        <div class="form-group">
            <label>ìƒì„¸ ì´ë¯¸ì§€ URL <span style="font-weight:400; color:#adb5bd">(ì„ íƒ)</span></label>
            <input type="file" id="createDetailImageFile" accept="image/*">
            <input type="hidden" id="createDetailImageUrl">
        </div>

        <div class="modal-footer">
            <button class="btn-common logout-btn" onclick="closeCreateModal()">ì·¨ì†Œ</button>
            <button class="btn-common home-btn" onclick="createTimeDeal()">ë“±ë¡í•˜ê¸°</button>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     íƒ€ì„ë”œ ìˆ˜ì • ëª¨ë‹¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal" id="editModal">
    <div class="modal-content">
        <div class="modal-title">âœï¸ íƒ€ì„ë”œ ìˆ˜ì •</div>

        <!-- ìƒí’ˆ ì •ë³´ (ì½ê¸° ì „ìš©) -->
        <div class="form-group">
            <label>ìƒí’ˆ</label>
            <div class="selected-product-card show" id="editProductCard"
                 style="background:#f8f9fa; border-color:#dee2e6;">
                <img id="editProductImg" src="" alt="" onerror="this.style.display='none'">
                <div class="selected-product-info">
                    <div class="name" id="editProductName"></div>
                    <div class="price" id="editProductPrice"></div>
                </div>
            </div>
        </div>

        <!-- ë”œ ê°€ê²© -->
        <div class="form-group">
            <label>ë”œ ê°€ê²© (ì›)</label>
            <input type="number" id="editDealPrice" placeholder="0" min="1">
            <div class="hint" id="editDiscountHint"></div>
        </div>

        <!-- ì‹œê°„ -->
        <div class="form-row">
            <div class="form-group">
                <label>ì‹œì‘ ì‹œê°„</label>
                <input type="datetime-local" id="editStartAt">
                <div class="hint">ë¶„ ë‹¨ìœ„ëŠ” ë¬´ì‹œë©ë‹ˆë‹¤ (ì‹œ ê¸°ì¤€ìœ¼ë¡œ ì „ì†¡)</div>
            </div>
            <div class="form-group">
                <label>ì¢…ë£Œ ì‹œê°„</label>
                <input type="datetime-local" id="editEndAt">
            </div>
        </div>

        <!-- ì´ë¯¸ì§€ -->
        <div class="form-group">
            <label>ëŒ€í‘œ ì´ë¯¸ì§€ URL <span style="font-weight:400; color:#adb5bd">(ì„ íƒ)</span></label>
            <input type="file" id="editImageFile" accept="image/*">
            <input type="hidden" id="editImageUrl">
        </div>
        <div class="form-group">
            <label>ìƒì„¸ ì´ë¯¸ì§€ URL <span style="font-weight:400; color:#adb5bd">(ì„ íƒ)</span></label>
            <input type="file" id="editDetailImageFile" accept="image/*">
            <input type="hidden" id="editDetailImageUrl">
        </div>

        <div class="modal-footer">
            <button class="btn-common logout-btn" onclick="closeEditModal()">ì·¨ì†Œ</button>
            <button class="btn-common delete-btn" onclick="deleteTimeDeal()">ì‚­ì œí•˜ê¸°</button>
            <button class="btn-common home-btn" onclick="updateTimeDeal()">ìˆ˜ì •í•˜ê¸°</button>
        </div>
    </div>
</div>

<footer>
    <p>Â© ì‹¹ì“°ë¦¬ - ëª¨ë‘ë¥¼ ìœ„í•œ ê·€ì—¬ìš´ êµ¿ì¦ˆ</p>
    <p>ê³ ê°ì„¼í„°: 010-1234-5678 | <a href="https://github.com/thk7964/Ssak3" class="__cf_email__">ì‹¹ì“°ë¦¬ í™ˆí˜ì´ì§€</a></p>
    <p>ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ | ì´ìš©ì•½ê´€ | ë°°ì†¡ì •ì±…</p>
</footer>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
    // API URL ì„¤ì •
    const API_URL = (() => {
        const hostname = window.location.hostname;

        if (hostname === 'localhost' || hostname === '127.0.0.1') {
            return 'http://localhost:8080';
        }

        if (hostname === 'admin.ssak3.store') {
            return 'https://admin.ssak3.store';
        }

        return 'https://ssak3.store';
    })();

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ì „ì—­ ìƒíƒœ
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const PAGE_GROUP = 10;
    let currentId = null;
    let currentPage = 0;
    let currentFilter = 'all';

    // ë“±ë¡ ëª¨ë‹¬ì—ì„œ ì„ íƒëœ ìƒí’ˆ ìºì‹œ
    let createSelectedProduct = null;
    // ìˆ˜ì • ëª¨ë‹¬ì—ì„œ í‘œì‹œìš© ì›ê°€ ìºì‹œ
    let editOriginalPrice = null;

    // ì „ì²´ íƒ€ì„ë”œ ëª©ë¡ (í´ë¼ì´ì–¸íŠ¸ í•„í„°ë§ìš© ìºì‹œ)
    let allTimeDealData = [];


    async function issuePresignedPut({ dirName, file }) {
        const url = `${API_URL}/ssak3/admin/images/presigned?dirName=${dirName}&fileName=${encodeURIComponent(file.name)}`;

        const res = await fetch(url, getRequestOptions('POST'));
        const result = await res.json();

        if (!result?.data) throw new Error("Presigned URL ë°œê¸‰ ì‹¤íŒ¨");

        return result.data;
        // { uploadUrl, imageUrl }
    }

    async function putToS3(uploadUrl, file) {
        const res = await fetch(uploadUrl, {
            method: 'PUT',
            headers: {
                'Content-Type': file.type
            },
            body: file
        });

        if (!res.ok) throw new Error("S3 ì—…ë¡œë“œ ì‹¤íŒ¨");
    }


    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ê³µí†µ fetch ì˜µì…˜
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getRequestOptions(method = 'GET', body = null) {
        const token = localStorage.getItem('accessToken');
        const headers = {'Content-Type': 'application/json'};
        if (token && token !== 'null' && token !== 'undefined') {
            headers['Authorization'] = `Bearer ${token}`;
        }
        const options = {method, headers, credentials: 'include'};
        if (body !== null) options.body = JSON.stringify(body);
        return options;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ì§„ì…ì 
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.addEventListener('DOMContentLoaded', () => {
        loadTimeDealList(0);
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ìƒíƒœ í•„í„°
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function setFilter(filter, el) {
        currentFilter = filter;
        document.querySelectorAll('.status-chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        loadTimeDealList(0);
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // íƒ€ì„ë”œ ëª©ë¡ ë¡œë“œ
    // GET /ssak3/admin/time-deals
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadTimeDealList(page = 0) {
        const statusParam = currentFilter && currentFilter !== 'all' ? `&status=${currentFilter.toUpperCase()}` : '';
        const url = `${API_URL}/ssak3/time-deals?page=${page}&size=10${statusParam}`;

        try {
            const res = await fetch(url, getRequestOptions());
            const result = await res.json();
            if (!result?.data) return;

            const pageData = result.data;
            currentPage = page;
            allTimeDealData = (pageData.content ?? []).filter(d => getStatus(d) !== 'deleted');

            renderFilteredTable();
            renderPagination(pageData);

            const displayCount = allTimeDealData.length;
            document.getElementById('totalCountDisplay').innerText =
                `ì „ì²´ íƒ€ì„ë”œ ${displayCount}ê°œ | í•œì‹œì  í• ì¸ ì´ë²¤íŠ¸ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”`

        } catch (err) {
            console.error('íƒ€ì„ë”œ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:', err);
            document.getElementById('timeDealTableBody').innerHTML =
                '<tr class="empty-row"><td colspan="8">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</td></tr>';
        }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // íƒ€ì„ë”œ ìƒíƒœ ê³„ì‚°
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function getStatus(d) {
        return d.status ? d.status.toLowerCase() : '';
    }

    function getStatusLabel(status) {
        return {
            ready: 'ì˜ˆì •',
            open: 'ì§„í–‰ì¤‘',
            closed: 'ì¢…ë£Œ'
        }[status] ?? status;
    }

    function getStatusBadgeClass(status) {
        return {
            ready: 'badge-upcoming',
            open: 'badge-active',
            closed: 'badge-ended'
        }[status] ?? '';
    }



    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // í…Œì´ë¸” ë Œë”ë§ (í•„í„° ì ìš©)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderFilteredTable() {
        const data = currentFilter === 'all'
            ? allTimeDealData
            : allTimeDealData.filter(d => getStatus(d) === currentFilter);
        renderTable(data);
    }

    function renderTable(list) {
        const tbody = document.getElementById('timeDealTableBody');
        if (!tbody) return;

        if (!list || list.length === 0) {
            tbody.innerHTML = '<tr class="empty-row"><td colspan="8">íƒ€ì„ë”œì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }

        tbody.innerHTML = list.map(d => {
            const status = getStatus(d);
            const statusLabel = getStatusLabel(status);
            const badgeClass = getStatusBadgeClass(status);
            const originalPrice = d.originalPrice ?? d.productPrice ?? d.price ?? 0;
            const dealPrice = d.dealPrice ?? 0;
            const discountRate = originalPrice > 0
                ? Math.floor((1 - dealPrice / originalPrice) * 100)
                : 0;

            const img = d.imageUrl ?? d.productImageUrl
                ? `<img src="${d.imageUrl ?? d.productImageUrl}" width="32" height="32"
                       style="border-radius:6px;object-fit:cover;vertical-align:middle;margin-right:8px;"
                       onerror="this.style.display='none'">`
                : '<span style="margin-right:8px;">âš¡</span>';

            const startStr = d.startAt ? d.startAt.replace('T', ' ').substring(0, 16) : '-';
            const endStr = d.endAt ? d.endAt.replace('T', ' ').substring(0, 16) : '-';


            return `
            <tr onclick="openEditModal(${d.id})">
                <td>${d.id}</td>
                <td>${img}<span style="font-weight:600">${d.productName ?? d.name ?? 'ìƒí’ˆëª… ì—†ìŒ'}</span></td>
                <td>
                    <span class="original-price">${originalPrice.toLocaleString()}ì›</span><br>
                    <strong style="color:#e17055">${dealPrice.toLocaleString()}ì›</strong>
                </td>
                <td><span class="discount-rate">${discountRate > 0 ? discountRate + '%' : '-'}</span></td>
                <td style="font-size:13px">${startStr}</td>
                <td style="font-size:13px">${endStr}</td>
                <td><span class="badge ${badgeClass}">${statusLabel}</span></td>
                <td style="font-size:13px">${d.createdAt ? d.createdAt.substring(0, 10) : '-'}</td>
            </tr>`;
        }).join('');
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // í˜ì´ì§€ë„¤ì´ì…˜
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderPagination(data) {
        const container = document.getElementById('pagination');
        if (!container) return;
        const totalPages = data.totalPages ?? 0;
        const current = currentPage;
        const groupStart = Math.floor(current / PAGE_GROUP) * PAGE_GROUP;
        const groupEnd = Math.min(groupStart + PAGE_GROUP, totalPages);

        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }

        let html = '';
        
        // ì²« í˜ì´ì§€ ë²„íŠ¼ (í˜„ì¬ í˜ì´ì§€ê°€ 0ì´ ì•„ë‹ ë•Œë§Œ í‘œì‹œ)
        if (current > 0) {
            html += `<button class="page-btn nav" onclick="loadTimeDealList(0)">ì²˜ìŒ</button>`;
        }
        
        // -10 ë²„íŠ¼ (í˜„ì¬ í˜ì´ì§€ê°€ 10 ì´ìƒì¼ ë•Œë§Œ í‘œì‹œ)
        if (current >= 10) {
            html += `<button class="page-btn nav" onclick="loadTimeDealList(${current - 10})">-10</button>`;
        }
        
        // ì´ì „ ë²„íŠ¼ (í˜„ì¬ í˜ì´ì§€ê°€ 0ë³´ë‹¤ í´ ë•Œë§Œ í‘œì‹œ, í•œ í˜ì´ì§€ì”© ì´ë™)
        if (current > 0) {
            html += `<button class="page-btn nav" onclick="loadTimeDealList(${current - 1})">ì´ì „</button>`;
        }
        
        // ìˆ«ì ë²„íŠ¼ë“¤
        for (let i = groupStart; i < groupEnd; i++) {
            const cls = (i === current) ? 'active' : '';
            html += `<button class="page-btn ${cls}" onclick="loadTimeDealList(${i})">${i + 1}</button>`;
        }
        
        // ë‹¤ìŒ ë²„íŠ¼ (í˜„ì¬ í˜ì´ì§€ê°€ ë§ˆì§€ë§‰ í˜ì´ì§€ê°€ ì•„ë‹ ë•Œë§Œ í‘œì‹œ, í•œ í˜ì´ì§€ì”© ì´ë™)
        if (current < totalPages - 1) {
            html += `<button class="page-btn nav" onclick="loadTimeDealList(${current + 1})">ë‹¤ìŒ</button>`;
        }
        
        // +10 ë²„íŠ¼ (í˜„ì¬ í˜ì´ì§€ + 10ì´ ì´ í˜ì´ì§€ ìˆ˜ë³´ë‹¤ ì‘ì„ ë•Œë§Œ í‘œì‹œ)
        if (current + 10 < totalPages) {
            html += `<button class="page-btn nav" onclick="loadTimeDealList(${current + 10})">+10</button>`;
        }
        
        // ë§ˆì§€ë§‰ í˜ì´ì§€ ë²„íŠ¼ (í˜„ì¬ í˜ì´ì§€ê°€ ë§ˆì§€ë§‰ í˜ì´ì§€ê°€ ì•„ë‹ ë•Œë§Œ í‘œì‹œ)
        if (current < totalPages - 1) {
            html += `<button class="page-btn nav" onclick="loadTimeDealList(${totalPages - 1})">ë</button>`;
        }
        
        container.innerHTML = html;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ìƒí’ˆ ê²€ìƒ‰ (ë“œë¡­ë‹¤ìš´)
    // GET /ssak3/admin/products?size=20&name=keyword
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let searchTimer = null;

    async function searchProducts(keyword, dropdownId) {
        clearTimeout(searchTimer);
        const dropdown = document.getElementById(dropdownId);

        if (!keyword.trim()) {
            dropdown.classList.remove('open');
            dropdown.innerHTML = '';
            return;
        }

        searchTimer = setTimeout(async () => {
            try {
                const url = `${API_URL}/ssak3/products/search?keyword=${encodeURIComponent(keyword.trim())}`;
                const res = await fetch(url, getRequestOptions());
                const result = await res.json();
                const items = result?.data?.content ?? [];

                if (items.length === 0) {
                    dropdown.innerHTML = '<div class="product-option" style="color:#adb5bd;cursor:default">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                } else {
                    dropdown.innerHTML = items.map(p => {
                        const imgTag = p.imageUrl
                            ? `<img src="${p.imageUrl}" onerror="this.style.display='none'">`
                            : `<span style="font-size:20px">ğŸ“¦</span>`;
                        return `
                        <div class="product-option" onclick="selectProduct(${p.id}, '${escapeHtml(p.name)}', ${p.price}, '${p.imageUrl ?? ''}', '${dropdownId}')">
                            ${imgTag}
                            <div>
                                <div class="prod-name">[${p.id}] ${escapeHtml(p.name)}</div>
                                <div class="prod-price">${(p.price ?? 0).toLocaleString()}ì›</div>
                            </div>
                        </div>`;
                    }).join('');
                }

                dropdown.classList.add('open');
            } catch (e) {
                console.error('ìƒí’ˆ ê²€ìƒ‰ ì‹¤íŒ¨:', e);
            }
        }, 300);
    }

    function escapeHtml(str) {
        return String(str ?? '').replace(/'/g, "\\'").replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    // ìƒí’ˆ ì„ íƒ (ë“±ë¡ ëª¨ë‹¬ ì „ìš©)
    function selectProduct(id, name, price, imageUrl, dropdownId) {
        createSelectedProduct = {id, name, price, imageUrl};

        document.getElementById('createProductId').value = id;
        document.getElementById('createProductSearch').value = '';
        document.getElementById('createSelectedName').textContent = `[${id}] ${name}`;
        document.getElementById('createSelectedPrice').textContent =
            price ? `ì›ê°€: ${price.toLocaleString()}ì›` : 'ì›ê°€ ì •ë³´ ì—†ìŒ';
        const imgEl = document.getElementById('createSelectedImg');
        if (imageUrl) {
            imgEl.src = imageUrl;
            imgEl.style.display = '';
        } else {
            imgEl.style.display = 'none';
        }

        document.getElementById('createSelectedCard').classList.add('show');
        document.getElementById(dropdownId).classList.remove('open');

        // ë”œ ê°€ê²© íŒíŠ¸ ì—…ë°ì´íŠ¸
        updateDiscountHint('create', price);
    }

    function clearProductSelection(prefix) {
        createSelectedProduct = null;
        document.getElementById(`${prefix}ProductId`).value = '';
        document.getElementById(`${prefix}ProductSearch`).value = '';
        document.getElementById(`${prefix}SelectedCard`).classList.remove('show');
        document.getElementById(`${prefix}DiscountHint`).textContent = '';
    }

    // ë”œ ê°€ê²© ì…ë ¥ ì‹œ í• ì¸ìœ¨ íŒíŠ¸
    function updateDiscountHint(prefix, originalPrice) {
        const dealPriceEl = document.getElementById(`${prefix}DealPrice`);
        if (!dealPriceEl) return;
        const handler = () => {
            const deal = parseInt(dealPriceEl.value) || 0;
            const hint = document.getElementById(`${prefix}DiscountHint`);
            if (deal > 0 && originalPrice > 0) {
                const rate = Math.round((1 - deal / originalPrice) * 100);
                hint.textContent = `ì›ê°€ ${originalPrice.toLocaleString()}ì› ê¸°ì¤€ â†’ í• ì¸ìœ¨ ${rate}%`;
                hint.style.color = rate > 0 ? '#e17055' : '#adb5bd';
            } else {
                hint.textContent = '';
            }
        };
        dealPriceEl.removeEventListener('input', dealPriceEl._hintHandler);
        dealPriceEl._hintHandler = handler;
        dealPriceEl.addEventListener('input', handler);
    }

    // ë“œë¡­ë‹¤ìš´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.product-search-wrap')) {
            document.querySelectorAll('.product-dropdown').forEach(d => d.classList.remove('open'));
        }
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // datetime-local â†’ yyyy-MM-dd'T'HH í¬ë§· ë³€í™˜
    // ì„œë²„: LocalDateTime pattern "yyyy-MM-dd'T'HH"
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function toServerDateFormat(datetimeLocalValue) {
        // "2024-06-15T14:30" â†’ "2024-06-15T14"
        if (!datetimeLocalValue) return null;
        return datetimeLocalValue.substring(0, 13); // "yyyy-MM-ddTHH"
    }

    // ì„œë²„ ê°’ â†’ datetime-local input ê°’ ë³€í™˜
    function toInputFormat(serverValue) {
        // "2024-06-15T14" â†’ "2024-06-15T14:00"
        if (!serverValue) return '';
        if (serverValue.length === 13) return serverValue + ':00';
        return serverValue.substring(0, 16);
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // íƒ€ì„ë”œ ë“±ë¡ ëª¨ë‹¬
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openCreateModal() {
        createSelectedProduct = null;
        document.getElementById('createProductSearch').value = '';
        document.getElementById('createProductId').value = '';
        document.getElementById('createSelectedCard').classList.remove('show');
        document.getElementById('createDealPrice').value = '';
        document.getElementById('createDiscountHint').textContent = '';
        document.getElementById('createStartAt').value = '';
        document.getElementById('createEndAt').value = '';
        document.getElementById('createImageUrl').value = '';
        document.getElementById('createDetailImageUrl').value = '';
        document.getElementById('createProductDropdown').classList.remove('open');
        document.getElementById('createModal').classList.add('active');
    }

    function closeCreateModal() {
        document.getElementById('createModal').classList.remove('active');
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // íƒ€ì„ë”œ ë“±ë¡ ì‹¤í–‰
    // POST /ssak3/admin/time-deals
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function createTimeDeal() {
        const productId = document.getElementById('createProductId').value;
        const dealPrice = parseInt(document.getElementById('createDealPrice').value) || 0;
        const startAtRaw = document.getElementById('createStartAt').value;
        const endAtRaw = document.getElementById('createEndAt').value;

        // ìœ íš¨ì„± ê²€ì‚¬
        if (!productId) {
            alert('ìƒí’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        if (dealPrice < 1) {
            alert('ë”œ ê°€ê²©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        if (!startAtRaw) {
            alert('ì‹œì‘ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        if (!endAtRaw) {
            alert('ì¢…ë£Œ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const startAt = toServerDateFormat(startAtRaw);
        const endAt = toServerDateFormat(endAtRaw);

        if (new Date(startAtRaw) >= new Date(endAtRaw)) {
            alert('ì¢…ë£Œ ì‹œê°„ì€ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤.');
            return;
        }

        const data = {
            productId: Number(productId),
            dealPrice,
            startAt,
            endAt,
            image: document.getElementById('createImageUrl').value.trim() || null,
            detailImage: document.getElementById('createDetailImageUrl').value.trim() || null,
        };

        console.log('âš¡ íƒ€ì„ë”œ ë“±ë¡ ìš”ì²­:', data);

        try {
            const res = await fetch(`${API_URL}/ssak3/admin/time-deals`, getRequestOptions('POST', data));

            if (res.status === 201) {
                alert('íƒ€ì„ë”œì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! âš¡');
                closeCreateModal();
                loadTimeDealList(0);
            } else {
                const err = await res.json().catch(() => ({}));
                alert(`ë“±ë¡ ì‹¤íŒ¨: ${err.message ?? 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}`);
            }
        } catch (e) {
            console.error('íƒ€ì„ë”œ ë“±ë¡ ì˜¤ë¥˜:', e);
            alert('ì„œë²„ì™€ì˜ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // íƒ€ì„ë”œ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
    // GET /ssak3/admin/time-deals/{id} ë˜ëŠ” ëª©ë¡ì—ì„œ ìºì‹œ í™œìš©
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function openEditModal(id) {
        currentId = id;

        // ìºì‹œì—ì„œ ë¨¼ì € ì°¾ê¸°
        let d = allTimeDealData.find(item => item.id === id);

        // ìºì‹œì— ì—†ìœ¼ë©´ ê°œë³„ ì¡°íšŒ ì‹œë„ (APIê°€ ìˆì„ ê²½ìš°)
        if (!d) {
            try {
                const res = await fetch(`${API_URL}/ssak3/admin/time-deals/${id}`, getRequestOptions());
                const result = await res.json();
                d = result?.data;
            } catch (e) {
                console.warn('ê°œë³„ íƒ€ì„ë”œ ì¡°íšŒ ì‹¤íŒ¨, ëª©ë¡ ìºì‹œ ì‚¬ìš© ë¶ˆê°€:', e);
                alert('íƒ€ì„ë”œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                return;
            }
        }

        if (!d) {
            alert('íƒ€ì„ë”œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // ìƒí’ˆ ì •ë³´ í‘œì‹œ (ì½ê¸° ì „ìš©)
        editOriginalPrice = d.originalPrice ?? d.productPrice ?? d.price ?? null;
        const prodName = d.productName ?? d.name ?? 'ìƒí’ˆëª… ì—†ìŒ';
        const prodPrice = editOriginalPrice ?? 0;
        const imgUrl = d.imageUrl ?? d.productImageUrl ?? '';

        document.getElementById('editProductName').textContent = prodName;
        document.getElementById('editProductPrice').textContent = prodPrice
            ? `ì›ê°€: ${prodPrice.toLocaleString()}ì›` : '';

        const editImg = document.getElementById('editProductImg');
        if (imgUrl) {
            editImg.src = imgUrl;
            editImg.style.display = '';
        } else {
            editImg.style.display = 'none';
        }

        // ë”œ ê°€ê²©
        document.getElementById('editDealPrice').value = d.dealPrice ?? '';
        if (editOriginalPrice) updateDiscountHint('edit', editOriginalPrice);

        // ì‹œê°„
        document.getElementById('editStartAt').value = toInputFormat(d.startAt ?? '');
        document.getElementById('editEndAt').value = toInputFormat(d.endAt ?? '');

        // ì´ë¯¸ì§€
        document.getElementById('editImageUrl').value = d.imageUrl ?? '';
        document.getElementById('editDetailImageUrl').value = d.detailImageUrl ?? '';

        document.getElementById('editModal').classList.add('active');
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.remove('active');
        currentId = null;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // íƒ€ì„ë”œ ìˆ˜ì • ì‹¤í–‰
    // PATCH /ssak3/admin/time-deals/{timeDealId}
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function updateTimeDeal() {
        if (!currentId) return;

        const startAtRaw = document.getElementById('editStartAt').value;
        const endAtRaw = document.getElementById('editEndAt').value;

        if (startAtRaw && endAtRaw && new Date(startAtRaw) >= new Date(endAtRaw)) {
            alert('ì¢…ë£Œ ì‹œê°„ì€ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤.');
            return;
        }

        const data = {};

        const dealPrice = parseInt(document.getElementById('editDealPrice').value);
        if (!isNaN(dealPrice) && dealPrice > 0) data.dealPrice = dealPrice;

        if (startAtRaw) data.startAt = toServerDateFormat(startAtRaw);
        if (endAtRaw) data.endAt = toServerDateFormat(endAtRaw);

        const img = document.getElementById('editImageUrl').value.trim();
        const detail = document.getElementById('editDetailImageUrl').value.trim();
        if (img) data.image = img;
        if (detail) data.detailImage = detail;

        console.log('âœï¸ íƒ€ì„ë”œ ìˆ˜ì • ìš”ì²­:', data);

        try {
            const res = await fetch(`${API_URL}/ssak3/admin/time-deals/${currentId}`,
                getRequestOptions('PATCH', data));

            if (res.ok) {
                alert('íƒ€ì„ë”œì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
                closeEditModal();
                loadTimeDealList(currentPage);
            } else {
                const err = await res.json().catch(() => ({}));
                alert(`ìˆ˜ì • ì‹¤íŒ¨: ${err.message ?? 'ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜'}`);
            }
        } catch (e) {
            console.error('íƒ€ì„ë”œ ìˆ˜ì • ì˜¤ë¥˜:', e);
            alert('ì„œë²„ì™€ì˜ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // íƒ€ì„ë”œ ì‚­ì œ
    // DELETE /ssak3/admin/time-deals/{timeDealId}
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function deleteTimeDeal() {
        if (!currentId) return;
        if (!confirm('ì •ë§ë¡œ ì´ íƒ€ì„ë”œì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;

        try {
            const res = await fetch(`${API_URL}/ssak3/admin/time-deals/${currentId}`,
                getRequestOptions('DELETE'));

            if (res.ok) {
                alert('íƒ€ì„ë”œì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ—‘ï¸');
                closeEditModal();
                loadTimeDealList(currentPage);
            } else {
                const err = await res.json().catch(() => ({}));
                alert(`ì‚­ì œ ì‹¤íŒ¨: ${err.message ?? 'ì´ë¯¸ ì‚­ì œëœ íƒ€ì„ë”œì´ê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'}`);
            }
        } catch (e) {
            console.error('íƒ€ì„ë”œ ì‚­ì œ ì˜¤ë¥˜:', e);
            alert('ì„œë²„ì™€ì˜ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ë¡œê·¸ì•„ì›ƒ
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('logoutBtn')?.addEventListener('click', () => {
        localStorage.removeItem('accessToken');
        location.href = 'login.html';
    });

    document.addEventListener('DOMContentLoaded', () => {
        // ê¸°ì¡´ íƒ€ì„ë”œ ëª©ë¡ ë¡œë“œ
        loadTimeDealList(0);

        // â”€â”€ flatpickr ì´ˆê¸°í™” â”€â”€
        const timeOptions = {
            enableTime: true,
            noCalendar: false,
            dateFormat: "Y-m-d\\TH",
            time_24hr: true,
            minuteIncrement: 60 // ë¶„ ë‹¨ìœ„ëŠ” ì„ íƒ ëª»í•˜ê²Œ
        };

        // ë“±ë¡ ëª¨ë‹¬
        flatpickr("#createStartAt", timeOptions);
        flatpickr("#createEndAt", timeOptions);

        // ìˆ˜ì • ëª¨ë‹¬
        flatpickr("#editStartAt", timeOptions);
        flatpickr("#editEndAt", timeOptions);

// ë“±ë¡ - ëŒ€í‘œ ì´ë¯¸ì§€
        document.getElementById('createImageFile')
            ?.addEventListener('change', async function () {

                const file = this.files[0];
                if (!file) return;

                try {
                    alert("ëŒ€í‘œ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...");

                    const presigned = await issuePresignedPut({
                        dirName: "timedeals",
                        file
                    });

                    await putToS3(presigned.uploadUrl, file);

                    document.getElementById('createImageUrl').value = presigned.imageUrl;

                    alert("ì—…ë¡œë“œ ì™„ë£Œ âœ…");
                } catch (e) {
                    console.error(e);
                    alert("ì—…ë¡œë“œ ì‹¤íŒ¨ âŒ");
                }
            });

        // ë“±ë¡ - ìƒì„¸ ì´ë¯¸ì§€
        document.getElementById('createDetailImageFile')
            ?.addEventListener('change', async function () {

                const file = this.files[0];
                if (!file) return;

                try {
                    const presigned = await issuePresignedPut({
                        dirName: "timedeals/detail",
                        file
                    });

                    await putToS3(presigned.uploadUrl, file);

                    document.getElementById('createDetailImageUrl').value = presigned.imageUrl;

                    alert("ìƒì„¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ âœ…");
                } catch (e) {
                    console.error(e);
                    alert("ì—…ë¡œë“œ ì‹¤íŒ¨ âŒ");
                }
            });

        // ìˆ˜ì • - ëŒ€í‘œ ì´ë¯¸ì§€
        document.getElementById('editImageFile')
            ?.addEventListener('change', async function () {

                const file = this.files[0];
                if (!file) return;

                try {
                    const presigned = await issuePresignedPut({
                        dirName: "timedeals",
                        file
                    });

                    await putToS3(presigned.uploadUrl, file);

                    document.getElementById('editImageUrl').value = presigned.imageUrl;

                    alert("ì—…ë¡œë“œ ì™„ë£Œ âœ…");
                } catch (e) {
                    console.error(e);
                    alert("ì—…ë¡œë“œ ì‹¤íŒ¨ âŒ");
                }
            });

        // ìˆ˜ì • - ìƒì„¸ ì´ë¯¸ì§€
        document.getElementById('editDetailImageFile')
            ?.addEventListener('change', async function () {

                const file = this.files[0];
                if (!file) return;

                try {
                    const presigned = await issuePresignedPut({
                        dirName: "timedeals/detail",
                        file
                    });

                    await putToS3(presigned.uploadUrl, file);

                    document.getElementById('editDetailImageUrl').value = presigned.imageUrl;

                    alert("ìƒì„¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ âœ…");
                } catch (e) {
                    console.error(e);
                    alert("ì—…ë¡œë“œ ì‹¤íŒ¨ âŒ");
                }
            });
    });
</script>
</body>
</html>