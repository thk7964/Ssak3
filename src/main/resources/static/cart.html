<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ì¥ë°”êµ¬ë‹ˆ - ì‹¹ì“°ë¦¬</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Apple SD Gothic Neo', sans-serif;
            background: #fafafa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìƒë‹¨ë°” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        header {
            width: 100%;
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255,255,255,0.5);
            box-shadow: 0 2px 16px rgba(116, 185, 255, 0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 28px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .logo {
            font-size: 22px;
            font-weight: 800;
            background: linear-gradient(135deg, #74b9ff 0%, #a29bfe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
            cursor: pointer;
            flex-shrink: 0;
            text-decoration: none;
        }

        /* ê°€ìš´ë° ê²€ìƒ‰ì°½ */
        .header-search {
            flex: 1;
            max-width: 400px;
            margin: 0 20px;
            display: flex;
            align-items: center;
            background: #f3f4f6;
            border-radius: 10px;
            border: 1.5px solid transparent;
            overflow: hidden;
            transition: all 0.15s ease;
        }

        .header-search:focus-within {
            background: white;
            border-color: #a29bfe;
            box-shadow: 0 0 0 3px rgba(162, 155, 254, 0.12);
        }

        .header-search input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 9px 14px;
            font-size: 14px;
            color: #374151;
            outline: none;
        }

        .header-search input::placeholder {
            color: #9ca3af;
        }

        .header-search-btn {
            border: none;
            background: transparent;
            padding: 9px 14px;
            font-size: 13px;
            font-weight: 600;
            color: #a29bfe;
            cursor: pointer;
            white-space: nowrap;
            transition: color 0.15s ease;
            border-left: 1.5px solid #e5e7eb;
        }

        .header-search-btn:hover {
            color: #74b9ff;
        }

        .header-nav {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .navbar-link {
            padding: 8px 16px;
            color: #4b5563;
            font-size: 14px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.15s ease;
            border: none;
            background: transparent;
            white-space: nowrap;
        }

        .navbar-link:hover {
            color: #74b9ff;
            background: rgba(116, 185, 255, 0.08);
        }

        .navbar-link.active {
            color: #a29bfe;
            font-weight: 700;
        }

        .navbar-divider {
            width: 1px;
            height: 18px;
            background: #e5e7eb;
            margin: 0 4px;
        }

        /* ë¡œê·¸ì¸ â€” ê¸€ì ìŠ¤íƒ€ì¼ */
        .auth-btn {
            padding: 8px 16px;
            color: #4b5563;
            font-size: 14px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.15s ease;
            border: none;
            background: transparent;
            white-space: nowrap;
        }

        .auth-btn:hover {
            color: #74b9ff;
            background: rgba(116, 185, 255, 0.08);
        }

        /* ë¡œê·¸ì¸ ëœ ê²½ìš° */
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-info .navbar-link {
            color: #000000;
        }

        .logout-btn {
            padding: 8px 16px;
            color: #ef4444;
            font-size: 14px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.15s ease;
            border: none;
            background: transparent;
            white-space: nowrap;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.08);
        }

        /* page */
        .page {
            flex: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 28px 28px 60px;
            width: 100%;
        }

        .page-title {
            font-size: 28px;
            font-weight: 800;
            color: #212529;
            letter-spacing: -0.5px;
            margin-bottom: 18px;
            text-align: center;
        }

        .layout {
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 24px;
            align-items: start;
        }

        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.06);
            border: 1px solid #f0f0f0;
            overflow: hidden;
        }

        .card-header {
            padding: 18px 20px;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .muted {
            color: #6b7280;
            font-size: 13px;
        }

        .select-all {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            color: #212529;
            user-select: none;
        }

        .danger-btn {
            border: none;
            background: #ffeded;
            color: #ff6b6b;
            padding: 10px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            font-size: 13px;
            transition: transform .15s ease, box-shadow .15s ease;
        }
        .danger-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 18px rgba(255, 107, 107, 0.18);
        }
        .danger-btn:disabled { opacity: .5; cursor: not-allowed; transform: none; box-shadow: none; }

        .list {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .item {
            display: grid;
            grid-template-columns: 28px 96px 1fr auto;
            gap: 14px;
            padding: 14px;
            border-radius: 16px;
            border: 1px solid #f0f0f0;
            transition: all .2s ease;
            cursor: pointer;
        }
        .item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 28px rgba(0,0,0,0.06);
            border-color: #e9ecef;
        }

        .item.disabled {
            opacity: 0.55;
            cursor: default;
        }
        .item.disabled:hover {
            transform: none;
            box-shadow: none;
            border-color: #f0f0f0;
        }

        .chk {
            display: flex;
            align-items: flex-start;
            padding-top: 6px;
        }

        .thumb {
            width: 96px;
            height: 96px;
            border-radius: 16px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid #f0f0f0;
            flex-shrink: 0;
            font-size: 38px;
        }
        .thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 0;
        }

        .name-row {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 0;
        }
        .name {
            font-size: 16px;
            font-weight: 800;
            color: #212529;
            letter-spacing: -0.3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 800;
            white-space: nowrap;
            user-select: none;
        }
        .badge.ok {
            background: #d1fae5;
            color: #065f46;
        }
        .badge.no {
            background: #fee2e2;
            color: #991b1b;
        }

        .price {
            font-size: 18px;
            font-weight: 800;
            background: linear-gradient(135deg, #74b9ff 0%, #a29bfe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            width: fit-content;
        }

        .sub {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        .qty-box {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 14px;
            border: 1px solid #eef2f7;
            background: #f8fdff;
        }

        .qty-btn {
            width: 34px;
            height: 34px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 800;
            color: #495057;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }
        .qty-btn:hover { border-color: #74b9ff; color: #74b9ff; }
        .qty-btn:disabled { opacity: .5; cursor: not-allowed; border-color: #e5e7eb; color: #9ca3af; }

        .qty-val {
            min-width: 28px;
            text-align: center;
            font-weight: 800;
            color: #212529;
        }

        .line {
            font-size: 14px;
            color: #374151;
            font-weight: 800;
        }

        .right {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
            justify-content: space-between;
        }

        .trash {
            border: none;
            background: #f8f9fa;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            transition: all .2s ease;
            user-select: none;
        }
        .trash:hover { background: #e9ecef; transform: translateY(-1px); }
        .trash:disabled { opacity: .5; cursor: not-allowed; transform: none; }

        .summary {
            padding: 18px 20px;
        }

        .summary-title {
            font-size: 16px;
            font-weight: 900;
            color: #212529;
            margin-bottom: 12px;
        }

        .row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed #eef2f7;
            color: #374151;
            font-weight: 700;
        }
        .row:last-child { border-bottom: none; }

        .total {
            font-size: 20px;
            font-weight: 900;
            color: #212529;
            letter-spacing: -0.3px;
        }

        .buy-btn {
            width: 100%;
            margin-top: 14px;
            padding: 16px 18px;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            font-weight: 800;
            font-size: 15px;
            background: linear-gradient(135deg, #74b9ff 0%, #a29bfe 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(116, 185, 255, 0.4);
            transition: all .2s ease;
        }
        .buy-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(116, 185, 255, 0.5); }
        .buy-btn:disabled { opacity: .5; cursor: not-allowed; transform: none; box-shadow: none; }

        .empty {
            padding: 60px 20px;
            text-align: center;
            color: #6b7280;
        }
        .empty .emoji { font-size: 50px; margin-bottom: 10px; }
        .empty .msg { font-size: 16px; font-weight: 700; color: #374151; }
        .empty .submsg { margin-top: 8px; font-size: 13px; }

        .ghost-btn {
            margin-top: 16px;
            border: 2px solid #74b9ff;
            background: white;
            color: #74b9ff;
            padding: 12px 16px;
            border-radius: 14px;
            cursor: pointer;
            font-weight: 800;
            transition: all .2s ease;
        }
        .ghost-btn:hover {
            background: #74b9ff;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(116, 185, 255, 0.3);
        }

        @media (max-width: 980px) {
            .layout { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            header {
                padding: 16px 20px;
                flex-wrap: wrap;
            }
            .search-container {
                order: 3;
                width: 100%;
                max-width: 100%;
                margin-top: 12px;
            }
            .item { grid-template-columns: 28px 84px 1fr; }
            .right { grid-column: 1 / -1; flex-direction: row; align-items: center; justify-content: flex-end; gap: 10px; }
            .thumb { width: 84px; height: 84px; }
        }

        footer {
            background: #212529;
            color: #adb5bd;
            text-align: center;
            padding: 40px 20px;
            margin-top: 60px;
        }

        footer p {
            margin: 10px 0;
            font-size: 14px;
            line-height: 1.6;
        }

        footer p:first-child {
            color: white;
            font-weight: 600;
            font-size: 15px;
        }

        footer a {
            color: #adb5bd;
        }
    </style>
</head>
<body>
<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ìƒë‹¨ë°” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<header>
    <div class="header-inner">
        <a class="logo" onclick="location.href='home.html'">SSAK3</a>

        <!-- ê°€ìš´ë° ê²€ìƒ‰ì°½ -->
        <div class="header-search">
            <input
                    type="text"
                    id="searchInput"
                    placeholder="ìƒí’ˆì„ ê²€ìƒ‰í•´ë³´ì„¸ìš”"
                    onkeypress="handleSearchEnter(event)"
            >
            <button class="header-search-btn" onclick="handleSearch()">ê²€ìƒ‰</button>
        </div>

        <div class="header-nav">
            <a class="navbar-link" onclick="location.href='product-search.html'">ì „ì²´ ìƒí’ˆ</a>
            <a class="navbar-link" onclick="location.href='time-deals.html'">íƒ€ì„ë”œ</a>
            <a class="navbar-link active" onclick="location.href='cart.html'">ì¥ë°”êµ¬ë‹ˆ</a>
            <div class="navbar-divider"></div>

            <!-- ë¡œê·¸ì¸ ì•ˆ ëœ ê²½ìš° -->
            <button class="auth-btn" id="loginBtn" style="display: none;">ë¡œê·¸ì¸ / íšŒì›ê°€ì…</button>

            <!-- ë¡œê·¸ì¸ ëœ ê²½ìš° -->
            <div class="user-info" id="userInfo" style="display: none;">
                <a class="navbar-link active" id="myPageBtn">ë§ˆì´í˜ì´ì§€</a>
                <a class="navbar-link" id="logoutBtn" style="color:#ef4444;">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
        </div>
    </div>
</header>

<div class="page">
    <h1 class="page-title">ì¥ë°”êµ¬ë‹ˆ</h1>

    <div class="layout">
        <!-- left -->
        <div class="card">
            <div class="card-header">
                <label class="select-all">
                    <input type="checkbox" id="selectAllChk" />
                    ì „ì²´ ì„ íƒ <span class="muted">(êµ¬ë§¤ ê°€ëŠ¥ ìƒí’ˆë§Œ)</span>
                </label>

                <button class="danger-btn" id="deleteSelectedBtn" disabled>ì„ íƒ ì‚­ì œ</button>
            </div>

            <div class="list" id="cartList"></div>
        </div>

        <!-- right -->
        <div class="card">
            <div class="summary">
                <div class="summary-title">ê²°ì œ ìš”ì•½</div>

                <div class="row">
                    <span>ì„ íƒ ìƒí’ˆ ìˆ˜</span>
                    <span id="selectedCount">0ê°œ</span>
                </div>
                <div class="row">
                    <span>ì„ íƒ í•©ê³„</span>
                    <span class="total" id="selectedTotal">0ì›</span>
                </div>

                <button class="buy-btn" id="buySelectedBtn" disabled>ì„ íƒ ìƒí’ˆ êµ¬ë§¤í•˜ê¸°</button>
                <div class="muted" style="margin-top:10px;">
                    â€» êµ¬ë§¤ ë¶ˆê°€ ìƒí’ˆì€ ì„ íƒí•  ìˆ˜ ì—†ì–´ìš”.
                </div>
            </div>
        </div>
    </div>
</div>

<footer>
    <p>Â© ì‹¹ì“°ë¦¬ - ëª¨ë‘ë¥¼ ìœ„í•œ ê·€ì—¬ìš´ êµ¿ì¦ˆ</p>
    <p>ê³ ê°ì„¼í„°: 010-1234-5678 | <a href="https://github.com/thk7964/Ssak3">ì‹¹ì“°ë¦¬ í™ˆí˜ì´ì§€</a></p>
    <p>ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ | ì´ìš©ì•½ê´€ | ë°°ì†¡ì •ì±…</p>
</footer>

<script>
    // API URL ì„¤ì •
    const API_URL = (() => {
        const hostname = window.location.hostname;

        if (hostname === 'localhost' || hostname === '127.0.0.1') {
            return 'http://localhost:8080';
        }

        if (hostname === 'admin.ssak3.store') {
            return 'https://admin.ssak3.store';
        }

        return 'https://ssak3.store';
    })();

    async function checkLogin() {
        try {
            const res = await apiFetch('/users/me', { method: 'GET' });

            if (res.ok) {
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('userInfo').style.display = 'flex';
            } else {
                document.getElementById('loginBtn').style.display = 'inline-block';
                document.getElementById('userInfo').style.display = 'none';
            }
        } catch (e) {
            document.getElementById('loginBtn').style.display = 'inline-block';
            document.getElementById('userInfo').style.display = 'none';
        }
    }

    // ìƒíƒœ
    let cartData = null;
    const selected = new Set();  // cartProductId
    const pending = new Set();   // cartProductId (ìš”ì²­ ì¤‘)

    // ------- ê²€ìƒ‰ -------
    function handleSearch() {
        const keyword = document.getElementById('searchInput').value.trim();
        if (keyword) window.location.href = `product-search.html?keyword=${encodeURIComponent(keyword)}&page=0`;
        else window.location.href = `product-search.html`;
    }
    function handleSearchEnter(event) { if (event.key === 'Enter') handleSearch(); }

    // ------- í—¤ë”(ë¡œê·¸ì¸ UI) -------
    function applyHeaderAuthUI() {
        const token = localStorage.getItem('accessToken');
        const loginBtn = document.getElementById('loginBtn');
        const userInfo = document.getElementById('userInfo');

        if (token) {
            loginBtn.style.display = 'none';
            userInfo.style.display = 'flex';
        } else {
            loginBtn.style.display = 'inline-block';
            userInfo.style.display = 'none';
        }
    }

    function initHeaderActions() {
        document.getElementById('myPageBtn').onclick = () => location.href = 'mypage.html';
        document.getElementById('loginBtn').onclick = () => location.href = 'login.html';
        document.getElementById('logoutBtn').onclick = () => {
            localStorage.removeItem('accessToken');
            applyHeaderAuthUI();
            alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
            location.href = 'home.html';
        };
    }

    // ------- ìœ í‹¸ -------
    function formatWon(n) {
        const num = Number(n || 0);
        return num.toLocaleString('ko-KR') + 'ì›';
    }

    function getPurchasableItems() {
        const list = (cartData && cartData.productList) ? cartData.productList : [];
        return list.filter(p => p.purchasable === true);
    }

    function getItemById(cartProductId) {
        const list = (cartData && cartData.productList) ? cartData.productList : [];
        return list.find(p => String(p.cartProductId) === String(cartProductId));
    }

    // ------- ë¶€ë¶„ ì—…ë°ì´íŠ¸ í—¬í¼(í•µì‹¬) -------
    function getItemEl(cartProductId) {
        return document.querySelector(`.item[data-id="${String(cartProductId)}"]`);
    }

    function setItemPending(cartProductId, isPending) {
        const el = getItemEl(cartProductId);
        if (!el) return;

        const minus = el.querySelector('.minus');
        const plus = el.querySelector('.plus');
        const trash = el.querySelector('.trash');

        if (minus) minus.disabled = isPending ? true : minus.disabled;
        if (plus)  plus.disabled  = isPending ? true : plus.disabled;
        if (trash) trash.disabled = isPending ? true : false;
    }

    function applyQuantityUpdateToDom(cartProductId) {
        const el = getItemEl(cartProductId);
        const item = getItemById(cartProductId);
        if (!el || !item) return;

        const qtyVal = el.querySelector('.qty-val');
        const line = el.querySelector('.line');
        const price = el.querySelector('.price');
        const minus = el.querySelector('.minus');
        const plus = el.querySelector('.plus');

        if (qtyVal) qtyVal.textContent = Number(item.quantity || 1);
        if (line) line.textContent = `í•©ê³„ ${formatWon(item.linePrice)}`;
        if (price) price.textContent = formatWon(item.unitPrice);

        const purchasable = item.purchasable === true;
        const isPending = pending.has(String(cartProductId));
        if (minus) minus.disabled = !purchasable || isPending || Number(item.quantity || 1) <= 1;
        if (plus)  plus.disabled  = !purchasable || isPending;
    }

    // ------- API fetch: í† í° ìš°ì„ , 401ì´ë©´ ì¿ í‚¤ ì‹œë„ -------
    async function apiFetch(path, options = {}) {
        const url = `${API_URL}/ssak3` + path;
        const token = localStorage.getItem('accessToken');

        if (token) {
            const res1 = await fetch(url, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    ...(options.headers || {}),
                    'Authorization': `Bearer ${token}`
                }
            });
            if (res1.status !== 401) return res1;
        }

        return fetch(url, {
            ...options,
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
                ...(options.headers || {})
            }
        });
    }

    // ------- ë Œë”(ì´ˆê¸°/ì‚­ì œ/êµ¬ë§¤ë¶ˆê°€ ì „í™˜ ì‹œë§Œ ì‚¬ìš©) -------
    function renderCart() {
        const listEl = document.getElementById('cartList');
        listEl.innerHTML = '';

        const list = (cartData && cartData.productList) ? cartData.productList : [];

        if (!list.length) {
            listEl.innerHTML = `
        <div class="empty">
          <div class="emoji">ğŸ›’</div>
          <div class="msg">ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆì–´ìš”</div>
          <div class="submsg">ë§ˆìŒì— ë“œëŠ” ìƒí’ˆì„ ë‹´ì•„ë³´ì„¸ìš”!</div>
          <button class="ghost-btn" onclick="location.href='home.html'">ìƒí’ˆ ë³´ëŸ¬ê°€ê¸°</button>
        </div>
      `;
            selected.clear();
            document.getElementById('selectAllChk').checked = false;
            updateSummary();
            updateSelectAllState();
            return;
        }

        for (const p of list) {
            const id = String(p.cartProductId);
            const isSelected = selected.has(id);
            const isPurchasable = p.purchasable === true;
            const isPending = pending.has(id);

            const itemEl = document.createElement('div');
            itemEl.className = 'item' + (isPurchasable ? '' : ' disabled');
            itemEl.dataset.id = id;

            const hasImg = !!p.imageUrl;

            itemEl.innerHTML = `
        <div class="chk">
          <input type="checkbox" class="itemChk" ${isSelected ? 'checked' : ''} ${isPurchasable ? '' : 'disabled'} />
        </div>

        <div class="thumb" aria-label="product image">
          ${hasImg ? `<img src="${String(p.imageUrl)}" alt="${p.productName || 'ìƒí’ˆ'}">` : `<span class="fallback">ğŸ§º</span>`}
        </div>

        <div class="info">
          <div class="name-row">
            <div class="name" title="${p.productName || ''}">${p.productName || '-'}</div>
            <span class="badge ${isPurchasable ? 'ok' : 'no'}">
              ${isPurchasable ? 'êµ¬ë§¤ ê°€ëŠ¥' : 'êµ¬ë§¤ ë¶ˆê°€'}
            </span>
          </div>

          <div class="price">${formatWon(p.unitPrice)}</div>

          <div class="sub">
            <div class="qty-box" role="group" aria-label="quantity">
              <button class="qty-btn minus" ${(!isPurchasable || isPending || Number(p.quantity) <= 1) ? 'disabled' : ''}>âˆ’</button>
              <div class="qty-val">${Number(p.quantity || 1)}</div>
              <button class="qty-btn plus" ${(!isPurchasable || isPending) ? 'disabled' : ''}>+</button>
            </div>
            <div class="line">í•©ê³„ ${formatWon(p.linePrice)}</div>
          </div>
        </div>

        <div class="right">
          <button class="trash" ${isPending ? 'disabled' : ''} title="ì‚­ì œ">ğŸ—‘ï¸</button>
        </div>
      `;

            // ì´ë¯¸ì§€ ë¡œë”© ì‹¤íŒ¨ ì‹œ ì´ëª¨ì§€ í‘œì‹œ
            const img = itemEl.querySelector('img');
            if (img) {
                img.onerror = () => {
                    img.remove();
                    const thumb = itemEl.querySelector('.thumb');
                    if (thumb) thumb.innerHTML = `<span class="fallback">ğŸ§º</span>`;
                };
            }

            // ì¹´ë“œ í´ë¦­ -> ì²´í¬ í† ê¸€ (êµ¬ë§¤ ê°€ëŠ¥ë§Œ)
            itemEl.addEventListener('click', (e) => {
                if (e.target.closest('button')) return;
                if (e.target.matches('input[type="checkbox"]')) return;
                if (!isPurchasable) return;

                const chk = itemEl.querySelector('.itemChk');
                chk.checked = !chk.checked;
                toggleSelected(id, chk.checked);
            });

            // ì²´í¬ë°•ìŠ¤ ì§ì ‘ ë³€ê²½
            itemEl.querySelector('.itemChk').addEventListener('change', (e) => {
                if (!isPurchasable) return;
                toggleSelected(id, e.target.checked);
            });

            // âœ… ìˆ˜ëŸ‰ - / + : ë£¨í”„ë³€ìˆ˜ pë¥¼ ì“°ì§€ ë§ê³  "í˜„ì¬" ë°ì´í„°ë¥¼ ì½ì–´ì„œ ê³„ì‚°
            itemEl.querySelector('.minus').addEventListener('click', async (e) => {
                e.stopPropagation();
                const cur = getItemById(id);
                if (!cur || cur.purchasable !== true) return;
                const nextQty = Math.max(1, Number(cur.quantity || 1) - 1);
                await updateQuantity(id, nextQty);
            });

            itemEl.querySelector('.plus').addEventListener('click', async (e) => {
                e.stopPropagation();
                const cur = getItemById(id);
                if (!cur || cur.purchasable !== true) return;
                const nextQty = Number(cur.quantity || 1) + 1;
                await updateQuantity(id, nextQty);
            });

            // ì‚­ì œ
            itemEl.querySelector('.trash').addEventListener('click', async (e) => {
                e.stopPropagation();
                await deleteOne(id);
            });

            listEl.appendChild(itemEl);
        }

        updateSummary();
        updateSelectAllState();
    }

    function toggleSelected(id, checked) {
        if (checked) selected.add(String(id));
        else selected.delete(String(id));

        updateSummary();
        updateSelectAllState();
    }

    function updateSummary() {
        let count = 0;
        let total = 0;

        for (const id of selected) {
            const item = getItemById(id);
            if (!item) continue;
            if (item.purchasable !== true) continue;
            count += 1;
            total += Number(item.linePrice || 0);
        }

        document.getElementById('selectedCount').textContent = `${count}ê°œ`;
        document.getElementById('selectedTotal').textContent = formatWon(total);

        document.getElementById('deleteSelectedBtn').disabled = (count === 0);
        document.getElementById('buySelectedBtn').disabled = (count === 0);
    }

    function updateSelectAllState() {
        const purchasable = getPurchasableItems();
        const purchasableIds = purchasable.map(p => String(p.cartProductId));

        const selectAll = document.getElementById('selectAllChk');

        if (purchasableIds.length === 0) {
            selectAll.checked = false;
            selectAll.indeterminate = false;
            return;
        }

        const selectedCount = purchasableIds.filter(id => selected.has(id)).length;

        if (selectedCount === 0) {
            selectAll.checked = false;
            selectAll.indeterminate = false;
        } else if (selectedCount === purchasableIds.length) {
            selectAll.checked = true;
            selectAll.indeterminate = false;
        } else {
            selectAll.checked = false;
            selectAll.indeterminate = true;
        }
    }

    // ------- ë°ì´í„° ë¡œë“œ -------
    async function loadCart() {
        try {
            const res = await apiFetch('/carts/me', { method: 'GET' });
            if (!res.ok) {
                if (res.status === 401 || res.status === 403) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    location.href = 'login.html';
                    return;
                }
                const text = await res.text().catch(() => '');
                throw new Error(text || `ì¥ë°”êµ¬ë‹ˆ ì¡°íšŒ ì‹¤íŒ¨ (${res.status})`);
            }

            const json = await res.json();
            cartData = json.data || { productList: [] };
            renderCart();
        } catch (err) {
            console.error(err);
            alert('ì¥ë°”êµ¬ë‹ˆë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ------- ìˆ˜ëŸ‰ ë³€ê²½(âœ… ë¶€ë¶„ ì—…ë°ì´íŠ¸: ì´ë¯¸ì§€ ìœ ì§€) -------
    async function updateQuantity(cartProductId, nextQty) {
        const id = String(cartProductId);
        if (pending.has(id)) return;

        const item = getItemById(id);
        if (!item) return;
        if (item.purchasable !== true) return;

        pending.add(id);
        // âœ… ì „ì²´ ë Œë” ê¸ˆì§€: í•´ë‹¹ ì¹´ë“œ ë²„íŠ¼ë§Œ ì ê¹ ë¹„í™œì„±í™”
        applyQuantityUpdateToDom(id);
        setItemPending(id, true);

        try {
            const res = await apiFetch('/carts', {
                method: 'PATCH',
                body: JSON.stringify({
                    cartProductId: Number(cartProductId),
                    quantity: Number(nextQty)
                })
            });

            if (!res.ok) {
                const text = await res.text().catch(() => '');
                throw new Error(text || `ìˆ˜ëŸ‰ ë³€ê²½ ì‹¤íŒ¨ (${res.status})`);
            }

            const json = await res.json();
            const updated = json.data; // { cartProductId, quantity, unitPrice, linePrice, purchasable }

            // ë¡œì»¬ cartData ë°˜ì˜ (imageUrlì€ ê·¸ëŒ€ë¡œ ìœ ì§€ë¨)
            const list = cartData.productList || [];
            const idx = list.findIndex(p => String(p.cartProductId) === String(updated.cartProductId));
            if (idx >= 0) {
                list[idx] = { ...list[idx], ...updated };
            }

            // êµ¬ë§¤ ê°€ëŠ¥ -> ë¶ˆê°€ë¡œ ë°”ë€Œë©´ êµ¬ì¡°(ì²´í¬ disabled, ë°°ì§€ ë“±) ë³€ê²½ì´ ìˆìœ¼ë‹ˆ ì „ì²´ ë Œë”
            if (updated.purchasable !== true) {
                selected.delete(String(updated.cartProductId));
                pending.delete(id);
                renderCart();
                return;
            }

            // âœ… ìˆ˜ëŸ‰/í•©ê³„/ê°€ê²©ë§Œ DOM ê°±ì‹  (ì´ë¯¸ì§€ëŠ” ê·¸ëŒ€ë¡œ)
            applyQuantityUpdateToDom(updated.cartProductId);

            // ìš”ì•½/ì „ì²´ì„ íƒ ìƒíƒœë§Œ ì—…ë°ì´íŠ¸
            updateSummary();
            updateSelectAllState();

        } catch (err) {
            console.error(err);
            alert('ìˆ˜ëŸ‰ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            await loadCart(); // ì•ˆì „ ì¬ë™ê¸°í™”
        } finally {
            pending.delete(id);
            // pending í•´ì œ í›„ ë²„íŠ¼ ìƒíƒœ ë‹¤ì‹œ ê³„ì‚°
            applyQuantityUpdateToDom(id);
            setItemPending(id, false);
        }
    }

    // ------- ì‚­ì œ -------
    async function deleteOne(cartProductId) {
        const id = String(cartProductId);
        if (pending.has(id)) return;

        pending.add(id);
        const el = getItemEl(id);
        if (el) setItemPending(id, true);

        try {
            const res = await apiFetch('/carts', {
                method: 'DELETE',
                body: JSON.stringify({ cartProductId: Number(cartProductId) })
            });

            if (!res.ok) {
                const text = await res.text().catch(() => '');
                throw new Error(text || `ì‚­ì œ ì‹¤íŒ¨ (${res.status})`);
            }

            selected.delete(id);
            cartData.productList = (cartData.productList || []).filter(p => String(p.cartProductId) !== id);
            pending.delete(id);

            // êµ¬ì¡° ë³€ê²½ì´ë¼ ì „ì²´ ë Œë”
            renderCart();
        } catch (err) {
            console.error(err);
            alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            await loadCart();
        } finally {
            pending.delete(id);
        }
    }

    async function deleteSelected() {
        const ids = Array.from(selected);
        if (ids.length === 0) return;

        if (!confirm(`ì„ íƒí•œ ${ids.length}ê°œ ìƒí’ˆì„ ì‚­ì œí• ê¹Œìš”?`)) return;

        for (const id of ids) {
            const item = getItemById(id);
            if (!item) { selected.delete(id); continue; }
            await deleteOne(id);
        }

        updateSummary();
        updateSelectAllState();
    }

    // ------- ì „ì²´ì„ íƒ -------
    function onSelectAllChanged(checked) {
        const purchasableIds = getPurchasableItems().map(p => String(p.cartProductId));
        if (checked) {
            for (const id of purchasableIds) selected.add(id);
        } else {
            for (const id of purchasableIds) selected.delete(id);
        }
        updateSummary();
        updateSelectAllState();
        // ì²´í¬ UI ë°˜ì˜ì´ í•„ìš”í•´ì„œ ì „ì²´ ë Œë” 1ë²ˆ
        renderCart();
    }

    // ------- êµ¬ë§¤ ë²„íŠ¼(âœ… "ì „ë‹¬ë§Œ" ìˆ˜í–‰) -------
    async function buySelected() {
        // ì„ íƒëœ ê²ƒ ì¤‘ êµ¬ë§¤ê°€ëŠ¥í•œ ê²ƒë§Œ ë‹¤ì‹œ í•„í„° (ì•ˆì „)
        const ids = Array.from(selected)
            .map(Number)
            .filter(Number.isFinite)
            .filter(id => {
                const item = getItemById(id);
                return item && item.purchasable === true;
            });

        if (ids.length === 0) return;

        // cartId í™•ë³´ (carts/me ì‘ë‹µì— ìˆì–´ì•¼ í•¨)
        const cid = Number(cartData?.cartId);
        if (!Number.isFinite(cid)) {
            alert('ì¥ë°”êµ¬ë‹ˆ ì •ë³´(cartId)ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            return;
        }

        // âœ… ì£¼ë¬¸ì„œ í˜ì´ì§€ë¡œ ì „ë‹¬
        sessionStorage.setItem('cartOrder.cartId', String(cid));
        sessionStorage.setItem('cartOrder.cartProductIdList', JSON.stringify(ids));

        // âœ… ì£¼ë¬¸ì„œ í˜ì´ì§€ë¡œ ì´ë™
        location.href = 'cart-order.html';
    }

    // ------- ì´ˆê¸°í™” -------
    function initEvents() {
        document.getElementById('selectAllChk').addEventListener('change', (e) => {
            onSelectAllChanged(e.target.checked);
        });

        document.getElementById('deleteSelectedBtn').addEventListener('click', deleteSelected);
        document.getElementById('buySelectedBtn').addEventListener('click', buySelected);
    }

    (async function init() {
        await checkLogin();
        initHeaderActions();
        initEvents();
        await loadCart();
    })();
</script>
</body>
</html>
