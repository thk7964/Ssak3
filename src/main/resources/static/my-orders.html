<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Ï£ºÎ¨∏ÎÇ¥Ïó≠ - ÏãπÏì∞Î¶¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Apple SD Gothic Neo', sans-serif;
            background: #fafafa;
            min-height: 100vh;
        }

        header {
            background: #ffffff;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #f0f0f0;
        }

        .logo {
            font-size: 26px;
            font-weight: 700;
            background: linear-gradient(135deg, #74b9ff 0%, #a29bfe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .header-icons {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .icon-btn {
            background: #f8f9fa;
            border: none;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s ease;
            color: #495057;
        }

        .icon-btn:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .auth-btn {
            background: linear-gradient(135deg, #74b9ff 0%, #a29bfe 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(116, 185, 255, 0.35);
            white-space: nowrap;
        }
        .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(116, 185, 255, 0.45); }

        .user-info { display: flex; align-items: center; gap: 12px; }
        .logout-btn {
            background: #f8f9fa;
            border: none;
            padding: 8px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 700;
            color: #495057;
            transition: all 0.2s ease;
        }
        .logout-btn:hover { background: #e9ecef; }

        .page {
            max-width: 980px;
            margin: 0 auto;
            padding: 28px 20px 60px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 900;
            color: #212529;
            letter-spacing: -0.5px;
            margin-bottom: 18px;
            text-align: center;
        }

        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.06);
            border: 1px solid #f0f0f0;
            overflow: hidden;
        }

        .list {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .order-item {
            border: 1px solid #f0f0f0;
            border-radius: 18px;
            padding: 16px;
            transition: all .2s ease;
            cursor: pointer;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 14px;
        }

        .order-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 28px rgba(0,0,0,0.06);
            border-color: #e9ecef;
        }

        .left .topline {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .order-no {
            font-weight: 900;
            color: #212529;
        }

        .muted {
            color: #6b7280;
            font-size: 13px;
            font-weight: 600;
        }

        .price {
            font-size: 18px;
            font-weight: 900;
            background: linear-gradient(135deg, #74b9ff 0%, #a29bfe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            width: fit-content;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 900;
            white-space: nowrap;
            user-select: none;
            border: 1px solid #eef2f7;
            background: #f8f9fa;
            color: #374151;
        }

        .badge.pending { background: #fff7ed; border-color: #fed7aa; color: #9a3412; }
        .badge.done { background: #d1fae5; border-color: #a7f3d0; color: #065f46; }
        .badge.canceled { background: #fee2e2; border-color: #fecaca; color: #991b1b; }
        .badge.failed { background: #eff6ff; border-color: #bfdbfe; color: #1d4ed8; }

        .right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
            justify-content: space-between;
            min-width: 170px;
        }

        .btn-row { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }

        .btn {
            border: none;
            border-radius: 12px;
            padding: 10px 12px;
            font-weight: 900;
            cursor: pointer;
            transition: all .15s ease;
            font-size: 13px;
            user-select: none;
        }

        .btn.primary {
            background: linear-gradient(135deg, #74b9ff 0%, #a29bfe 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(116, 185, 255, 0.25);
        }

        .btn.primary:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(116, 185, 255, 0.35); }

        .btn.danger {
            background: #ffeded;
            color: #ff6b6b;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.15);
        }
        .btn.danger:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(255, 107, 107, 0.22); }

        .btn:disabled { opacity: .55; cursor: not-allowed; transform: none !important; box-shadow: none !important; }

        .empty {
            padding: 60px 20px;
            text-align: center;
            color: #6b7280;
        }
        .empty .emoji { font-size: 50px; margin-bottom: 10px; }
        .empty .msg { font-size: 16px; font-weight: 800; color: #374151; }
        .empty .submsg { margin-top: 8px; font-size: 13px; }

        .footer-actions {
            margin-top: 14px;
            display: flex;
            justify-content: center;
        }

        .more-btn {
            border: none;
            border-radius: 16px;
            padding: 14px 18px;
            cursor: pointer;
            font-weight: 900;
            background: #f8f9fa;
            color: #374151;
            transition: all .15s ease;
        }
        .more-btn:hover { background: #e9ecef; transform: translateY(-1px); }
        .more-btn:disabled { opacity: .6; cursor: not-allowed; transform: none; }

        @media (max-width: 768px) {
            header { padding: 16px 20px; }
            .right { min-width: 0; align-items: flex-start; }
            .order-item { grid-template-columns: 1fr; }
            .btn-row { justify-content: flex-start; }
        }
    </style>
</head>
<body>
<header>
    <div class="logo" onclick="location.href='home.html'">üåä ÏãπÏì∞Î¶¨</div>
    <div class="header-icons">
        <button class="icon-btn"
                id="cartIconBtn"
                title="Ïû•Î∞îÍµ¨Îãà"
                onclick="location.href='cart.html'">
            üõí
        </button>

        <button class="auth-btn" id="loginBtn" style="display:none;">Î°úÍ∑∏Ïù∏ / ÌöåÏõêÍ∞ÄÏûÖ</button>

        <div class="user-info" id="userInfo" style="display:none;">
            <button class="icon-btn" id="myPageBtn" title="ÎßàÏù¥ÌéòÏù¥ÏßÄ">üë§</button>
            <button class="logout-btn" id="logoutBtn">Î°úÍ∑∏ÏïÑÏõÉ</button>
        </div>
    </div>
</header>

<div class="page">
    <h1 class="page-title">Ï£ºÎ¨∏ÎÇ¥Ïó≠</h1>

    <div class="card">
        <div class="list" id="orderList">
            <div class="empty">
                <div class="emoji">üì¶</div>
                <div class="msg">Ï£ºÎ¨∏ÎÇ¥Ïó≠ÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
                <div class="submsg">Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî</div>
            </div>
        </div>
    </div>

    <div class="footer-actions">
        <button class="more-btn" id="moreBtn" style="display:none;">Îçî Î≥¥Í∏∞</button>
    </div>
</div>

<script>
    const API_BASE = 'http://localhost:8080/ssak3';

    let page = 0;
    const size = 10;
    let isLast = false;
    let isLoading = false;

    function applyHeaderAuthUI() {
        const token = localStorage.getItem('accessToken');
        const loginBtn = document.getElementById('loginBtn');
        const userInfo = document.getElementById('userInfo');

        if (token) {
            loginBtn.style.display = 'none';
            userInfo.style.display = 'flex';
        } else {
            loginBtn.style.display = 'inline-block';
            userInfo.style.display = 'none';
        }
    }

    function initHeaderActions() {
        document.getElementById('cartIconBtn').onclick = () => location.href = 'cart.html';
        document.getElementById('myPageBtn').onclick = () => location.href = 'mypage.html';
        document.getElementById('loginBtn').onclick = () => location.href = 'login.html';
        document.getElementById('logoutBtn').onclick = () => {
            localStorage.removeItem('accessToken');
            applyHeaderAuthUI();
            alert('Î°úÍ∑∏ÏïÑÏõÉ ÎêòÏóàÏäµÎãàÎã§.');
            location.href = 'home.html';
        };
    }

    async function apiFetch(path, options = {}) {
        const url = API_BASE + path;
        const token = localStorage.getItem('accessToken');

        if (token) {
            const res1 = await fetch(url, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    ...(options.headers || {}),
                    'Authorization': `Bearer ${token}`
                }
            });
            if (res1.status !== 401) return res1;
        }

        return fetch(url, {
            ...options,
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
                ...(options.headers || {})
            }
        });
    }

    function formatWon(n) {
        const num = Number(n || 0);
        return num.toLocaleString('ko-KR') + 'Ïõê';
    }

    function formatDateTime(v) {
        if (!v) return '-';
        try {
            // LocalDateTimeÏù¥ "2026-02-12T12:34:56" ÌòïÌÉúÎ°ú Ïò§Î©¥ Ï≤òÎ¶¨
            const d = new Date(v);
            if (!Number.isNaN(d.getTime())) {
                return d.toLocaleString('ko-KR');
            }
            // ÌòπÏãú Î¨∏ÏûêÏó¥ Í∑∏ÎåÄÎ°úÎ©¥ Ï†ÅÎãπÌûà Í∞ÄÍ≥µ
            return String(v).replace('T', ' ');
        } catch {
            return String(v);
        }
    }

    function statusMeta(status) {
        const s = String(status || '');
        if (s === 'PAYMENT_PENDING') return { text: 'Í≤∞Ï†ú ÎåÄÍ∏∞', cls: 'pending' };
        if (s === 'DONE') return { text: 'Í≤∞Ï†ú ÏôÑÎ£å', cls: 'done' };
        if (s === 'CANCELED') return { text: 'Ï∑®ÏÜå', cls: 'canceled' };
        if (s === 'PAYMENT_FAILED') return { text: 'Í≤∞Ï†ú Ïã§Ìå®', cls: 'failed' };
        return { text: s || 'ÏÉÅÌÉú ÏóÜÏùå', cls: '' };
    }

    function getContentFromPageResponse(data) {
        // PageResponse Íµ¨Ï°∞Í∞Ä Ï†úÍ≥µÎêòÏßÄ ÏïäÏïÑ Ïú†Ïó∞ÌïòÍ≤å ÎåÄÏùë
        if (!data) return [];
        if (Array.isArray(data)) return data;
        return data.content || data.items || data.list || data.results || [];
    }

    function isLastPage(data) {
        if (!data || Array.isArray(data)) return true;
        if (typeof data.last === 'boolean') return data.last;
        if (typeof data.totalPages === 'number' && typeof data.number === 'number') {
            return (data.number + 1) >= data.totalPages;
        }
        // totalElements/size Í∏∞Î∞ò Ï∂îÏ†ï
        if (typeof data.totalElements === 'number' && typeof data.size === 'number' && typeof data.number === 'number') {
            return (data.number + 1) * data.size >= data.totalElements;
        }
        return false;
    }

    function renderEmpty() {
        const listEl = document.getElementById('orderList');
        listEl.innerHTML = `
      <div class="empty">
        <div class="emoji">üßæ</div>
        <div class="msg">Ï£ºÎ¨∏ÎÇ¥Ïó≠Ïù¥ ÏóÜÏñ¥Ïöî</div>
        <div class="submsg">ÏÉÅÌíàÏùÑ Ï£ºÎ¨∏Ìï¥Î≥¥ÏÑ∏Ïöî!</div>
      </div>
    `;
    }

    function appendOrders(list) {
        const listEl = document.getElementById('orderList');

        // Ï≤´ Î°úÎìúÏóêÏÑú "Î°úÎî©" emptyÍ∞Ä ÏûàÏúºÎ©¥ Ï†úÍ±∞
        const maybeEmpty = listEl.querySelector('.empty');
        if (maybeEmpty) listEl.innerHTML = '';

        for (const o of list) {
            const orderId = o.orderId;
            const totalPrice = o.totalPrice;
            const createdAt = o.createdAt;
            const st = statusMeta(o.orderStatus);

            const item = document.createElement('div');
            item.className = 'order-item';
            item.onclick = () => location.href = `order-detail.html?orderId=${encodeURIComponent(orderId)}`;

            const actionHtml = (String(o.orderStatus) === 'PAYMENT_PENDING')
                ? `
          <div class="btn-row">
            <button class="btn primary" data-action="retry">Ïû¨Í≤∞Ï†ú</button>
            <button class="btn danger" data-action="cancel">Ï£ºÎ¨∏ Ï∑®ÏÜå</button>
          </div>
        `
                : `<div class="btn-row"></div>`;

            item.innerHTML = `
        <div class="left">
          <div class="topline">
            <div class="order-no">Ï£ºÎ¨∏ #${orderId}</div>
            <span class="badge ${st.cls}">${st.text}</span>
          </div>
          <div class="price">${formatWon(totalPrice)}</div>
          <div class="muted">Ï£ºÎ¨∏Ïùº: ${formatDateTime(createdAt)}</div>
        </div>

        <div class="right">
          <div class="muted" style="text-align:right;">ÏÉÅÏÑ∏ Î≥¥Í∏∞ ‚Üí</div>
          ${actionHtml}
        </div>
      `;

            // Î≤ÑÌäº ÌÅ¥Î¶≠ÏùÄ Ïπ¥Îìú ÌÅ¥Î¶≠(ÏÉÅÏÑ∏Ïù¥Îèô) ÎßâÍ∏∞
            const retryBtn = item.querySelector('button[data-action="retry"]');
            const cancelBtn = item.querySelector('button[data-action="cancel"]');

            if (retryBtn) {
                retryBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    await retryPayment(orderId, retryBtn, cancelBtn);
                });
            }
            if (cancelBtn) {
                cancelBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    await cancelPending(orderId, retryBtn, cancelBtn);
                });
            }

            listEl.appendChild(item);
        }
    }

    async function retryPayment(orderId, retryBtn, cancelBtn) {
        if (retryBtn) retryBtn.disabled = true;
        if (cancelBtn) cancelBtn.disabled = true;

        try {
            const res = await apiFetch(`/orders/${orderId}/retry-payment`, { method: 'POST' });
            if (!res.ok) {
                const txt = await res.text().catch(() => '');
                throw new Error(txt || `Ïû¨Í≤∞Ï†ú Ïã§Ìå® (${res.status})`);
            }
            const json = await res.json();
            const url = json?.data?.url;
            if (!url) throw new Error('Í≤∞Ï†ú URLÏù¥ ÏóÜÏäµÎãàÎã§.');
            location.href = url;
        } catch (err) {
            console.error(err);
            alert('Ïû¨Í≤∞Ï†ú ÏöîÏ≤≠Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            if (retryBtn) retryBtn.disabled = false;
            if (cancelBtn) cancelBtn.disabled = false;
        }
    }

    async function cancelPending(orderId, retryBtn, cancelBtn) {
        if (!confirm('Í≤∞Ï†ú ÎåÄÍ∏∞ Ï£ºÎ¨∏ÏùÑ Ï∑®ÏÜåÌï†ÍπåÏöî?')) return;

        if (retryBtn) retryBtn.disabled = true;
        if (cancelBtn) cancelBtn.disabled = true;

        try {
            const res = await apiFetch(`/orders/${orderId}/cancel-pending`, { method: 'PATCH' });
            if (!res.ok) {
                const txt = await res.text().catch(() => '');
                throw new Error(txt || `Ï∑®ÏÜå Ïã§Ìå® (${res.status})`);
            }
            // Í∞ÄÏû• ÏïàÏ†Ñ: Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®(Ï≤´ ÌéòÏù¥ÏßÄÎ∂ÄÌÑ∞)
            page = 0;
            isLast = false;
            document.getElementById('orderList').innerHTML = '';
            await loadNextPage(true);
        } catch (err) {
            console.error(err);
            alert('Ï£ºÎ¨∏ Ï∑®ÏÜåÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            if (retryBtn) retryBtn.disabled = false;
            if (cancelBtn) cancelBtn.disabled = false;
        }
    }

    async function loadNextPage(force = false) {
        if (isLoading) return;
        if (isLast && !force) return;

        isLoading = true;
        const moreBtn = document.getElementById('moreBtn');
        moreBtn.disabled = true;

        try {
            const res = await apiFetch(`/orders?page=${page}&size=${size}`, { method: 'GET' });
            if (!res.ok) {
                if (res.status === 401 || res.status === 403) {
                    alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                    location.href = 'login.html';
                    return;
                }
                const txt = await res.text().catch(() => '');
                throw new Error(txt || `Ï£ºÎ¨∏ Î™©Î°ù Ï°∞Ìöå Ïã§Ìå® (${res.status})`);
            }

            const json = await res.json();
            const data = json.data;
            const list = getContentFromPageResponse(data);
            isLast = isLastPage(data);

            if (!list || list.length === 0) {
                if (page === 0) renderEmpty();
                moreBtn.style.display = 'none';
                return;
            }

            appendOrders(list);

            page += 1;

            moreBtn.style.display = isLast ? 'none' : 'inline-flex';
        } catch (err) {
            console.error(err);
            alert('Ï£ºÎ¨∏ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.');
        } finally {
            isLoading = false;
            moreBtn.disabled = false;
        }
    }

    (async function init() {
        applyHeaderAuthUI();
        initHeaderActions();

        document.getElementById('moreBtn').addEventListener('click', () => loadNextPage());

        await loadNextPage();
    })();
</script>
</body>
</html>
