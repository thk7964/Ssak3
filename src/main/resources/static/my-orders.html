<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Ï†ÑÏ≤¥ Ï£ºÎ¨∏ ÎÇ¥Ïó≠ - ÏãπÏì∞Î¶¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Apple SD Gothic Neo', sans-serif;
            background: #fafafa;
            min-height: 100vh;
        }

        header {
            background: #ffffff;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #f0f0f0;
        }

        .logo {
            font-size: 26px;
            font-weight: 700;
            background: linear-gradient(135deg, #74b9ff 0%, #a29bfe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .header-icons { display: flex; gap: 12px; align-items: center; }

        .icon-btn {
            background: #f8f9fa;
            border: none;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s ease;
            color: #495057;
        }
        .icon-btn:hover { background: #e9ecef; transform: translateY(-2px); }

        .auth-btn {
            background: linear-gradient(135deg, #74b9ff 0%, #a29bfe 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(116, 185, 255, 0.35);
            white-space: nowrap;
        }
        .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(116, 185, 255, 0.45); }

        .user-info { display: flex; align-items: center; gap: 12px; }
        .logout-btn {
            background: #f8f9fa;
            border: none;
            padding: 8px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 700;
            color: #495057;
            transition: all 0.2s ease;
        }
        .logout-btn:hover { background: #e9ecef; }

        .page {
            max-width: 980px;
            margin: 0 auto;
            padding: 28px 20px 60px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 900;
            color: #212529;
            letter-spacing: -0.5px;
            margin-bottom: 18px;
            text-align: center;
        }

        /* ‚úÖ ÌïÑÌÑ∞ ÌÜ†Í∏Ä UI */
        .filters {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 0 auto 16px;
            flex-wrap: wrap;
        }

        .filter-btn {
            border: 1px solid #eef2f7;
            background: #ffffff;
            color: #374151;
            padding: 10px 14px;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 900;
            font-size: 13px;
            transition: all .15s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            user-select: none;
        }

        .filter-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 24px rgba(0,0,0,0.06);
        }

        .filter-btn.active {
            border-color: transparent;
            background: linear-gradient(135deg, #74b9ff 0%, #a29bfe 100%);
            color: #fff;
            box-shadow: 0 8px 20px rgba(116, 185, 255, 0.25);
        }

        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.06);
            border: 1px solid #f0f0f0;
            overflow: hidden;
        }

        .list {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .order-item {
            border: 1px solid #f0f0f0;
            border-radius: 18px;
            padding: 16px;
            transition: all .2s ease;
            cursor: pointer;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 14px;
        }
        .order-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 28px rgba(0,0,0,0.06);
            border-color: #e9ecef;
        }

        .left .topline {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .order-no { font-weight: 900; color: #212529; }
        .muted { color: #6b7280; font-size: 13px; font-weight: 600; }

        .price {
            font-size: 18px;
            font-weight: 900;
            background: linear-gradient(135deg, #74b9ff 0%, #a29bfe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            width: fit-content;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 900;
            white-space: nowrap;
            user-select: none;
            border: 1px solid #eef2f7;
            background: #f8f9fa;
            color: #374151;
        }
        .badge.pending { background: #fff7ed; border-color: #fed7aa; color: #9a3412; }
        .badge.done { background: #d1fae5; border-color: #a7f3d0; color: #065f46; }
        .badge.canceled { background: #fee2e2; border-color: #fecaca; color: #991b1b; }
        .badge.failed { background: #eff6ff; border-color: #bfdbfe; color: #1d4ed8; }

        .right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
            justify-content: space-between;
            min-width: 170px;
        }

        .btn-row { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }

        .btn {
            border: none;
            border-radius: 12px;
            padding: 10px 12px;
            font-weight: 900;
            cursor: pointer;
            transition: all .15s ease;
            font-size: 13px;
            user-select: none;
        }

        .btn.primary {
            background: linear-gradient(135deg, #74b9ff 0%, #a29bfe 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(116, 185, 255, 0.25);
        }
        .btn.primary:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(116, 185, 255, 0.35); }

        .btn.danger {
            background: #ffeded;
            color: #ff6b6b;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.15);
        }
        .btn.danger:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(255, 107, 107, 0.22); }

        .btn:disabled { opacity: .55; cursor: not-allowed; transform: none !important; box-shadow: none !important; }

        .empty {
            padding: 60px 20px;
            text-align: center;
            color: #6b7280;
        }
        .empty .emoji { font-size: 50px; margin-bottom: 10px; }
        .empty .msg { font-size: 16px; font-weight: 800; color: #374151; }
        .empty .submsg { margin-top: 8px; font-size: 13px; }

        .footer-actions { margin-top: 14px; display: flex; justify-content: center; }

        .more-btn {
            border: none;
            border-radius: 16px;
            padding: 14px 18px;
            cursor: pointer;
            font-weight: 900;
            background: #f8f9fa;
            color: #374151;
            transition: all .15s ease;
        }
        .more-btn:hover { background: #e9ecef; transform: translateY(-1px); }
        .more-btn:disabled { opacity: .6; cursor: not-allowed; transform: none; }

        @media (max-width: 768px) {
            header { padding: 16px 20px; }
            .right { min-width: 0; align-items: flex-start; }
            .order-item { grid-template-columns: 1fr; }
            .btn-row { justify-content: flex-start; }
        }

        /* ===== ÏÑ∏Í∑∏Î®ºÌä∏ Î≤ÑÌäº ===== */
        .segment-wrap {
            display: flex;
            justify-content: center;
            margin-bottom: 22px;
        }
        .segment {
            display: inline-flex;
            background: #f0f0f0;
            border-radius: 16px;
            padding: 4px;
            gap: 4px;
        }
        .seg-btn {
            border: none;
            background: transparent;
            padding: 10px 28px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 900;
            color: #6b7280;
            cursor: pointer;
            transition: all .2s ease;
            user-select: none;
        }
        .seg-btn.active {
            background: #ffffff;
            color: #212529;
            box-shadow: 0 2px 8px rgba(0,0,0,0.10);
        }

        /* ===== Î¶¨Î∑∞ ÏïÑÏù¥ÌÖú ===== */
        .review-item {
            border: 1px solid #f0f0f0;
            border-radius: 18px;
            padding: 18px;
            transition: all .2s ease;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .review-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 28px rgba(0,0,0,0.06);
            border-color: #e9ecef;
        }
        .review-topline {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .review-product-name {
            font-weight: 900;
            color: #212529;
            font-size: 14px;
        }
        .review-stars { font-size: 15px; }
        .review-content {
            color: #374151;
            font-size: 14px;
            line-height: 1.6;
            font-weight: 500;
        }
        .review-date {
            color: #6b7280;
            font-size: 12px;
            font-weight: 600;
        }
        .review-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .review-delete-btn {
            border: none;
            background: #ffeded;
            color: #ff6b6b;
            padding: 7px 14px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 900;
            cursor: pointer;
            transition: all .15s ease;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.12);
        }
        .review-delete-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(255, 107, 107, 0.22); }
        .review-delete-btn:disabled { opacity: .55; cursor: not-allowed; transform: none; box-shadow: none; }
    </style>
</head>
<body>
<header>
    <div class="logo" onclick="location.href='home.html'">üåä ÏãπÏì∞Î¶¨</div>
    <div class="header-icons">
        <button class="icon-btn" id="cartIconBtn" title="Ïû•Î∞îÍµ¨Îãà" onclick="location.href='cart.html'">üõí</button>

        <button class="auth-btn" id="loginBtn" style="display:none;">Î°úÍ∑∏Ïù∏ / ÌöåÏõêÍ∞ÄÏûÖ</button>

        <div class="user-info" id="userInfo" style="display:none;">
            <button class="icon-btn" id="myPageBtn" title="ÎßàÏù¥ÌéòÏù¥ÏßÄ">üë§</button>
            <button class="logout-btn" id="logoutBtn">Î°úÍ∑∏ÏïÑÏõÉ</button>
        </div>
    </div>
</header>

<div class="page">
    <h1 class="page-title">Ï†ÑÏ≤¥ Ï£ºÎ¨∏ ÎÇ¥Ïó≠</h1>

    <!-- ÏÑ∏Í∑∏Î®ºÌä∏ Î≤ÑÌäº -->
    <div class="segment-wrap">
        <div class="segment">
            <button class="seg-btn active" id="segOrders" onclick="switchTab('orders')">Ï£ºÎ¨∏ ÎÇ¥Ïó≠</button>
            <button class="seg-btn" id="segReviews" onclick="switchTab('reviews')">ÎÇ¥Í∞Ä Ïì¥ Î¶¨Î∑∞</button>
        </div>
    </div>

    <!-- Ï£ºÎ¨∏ ÎÇ¥Ïó≠ ÏÑπÏÖò -->
    <div id="sectionOrders">

    <!-- ‚úÖ Ï†ÑÏ≤¥ Î≤ÑÌäº ÏóÜÏùå / ‚úÖ ÎàÑÎ•¥Î©¥ ÌÜ†Í∏ÄÎêòÎäî ÌïÑÌÑ∞ 3Í∞ú -->
    <div class="filters">
        <button class="filter-btn" data-status="PAYMENT_PENDING">Í≤∞Ï†ú ÎåÄÍ∏∞</button>
        <button class="filter-btn" data-status="DONE">Í≤∞Ï†ú ÏôÑÎ£å</button>
        <button class="filter-btn" data-status="CANCELED">Ï∑®ÏÜå</button>
    </div>

    <div class="card">
        <div class="list" id="orderList">
            <div class="empty">
                <div class="emoji">üì¶</div>
                <div class="msg">Ï£ºÎ¨∏ÎÇ¥Ïó≠ÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
                <div class="submsg">Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî</div>
            </div>
        </div>
    </div>

    <div class="footer-actions">
        <button class="more-btn" id="moreBtn" style="display:none;">Îçî Î≥¥Í∏∞</button>
    </div>

    </div><!-- /sectionOrders -->

    <!-- Î¶¨Î∑∞ ÏÑπÏÖò -->
    <div id="sectionReviews" style="display:none;">
        <div class="card">
            <div class="list" id="reviewList">
                <div class="empty">
                    <div class="emoji">üí¨</div>
                    <div class="msg">Î¶¨Î∑∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
                    <div class="submsg">Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî</div>
                </div>
            </div>
        </div>
        <div class="footer-actions">
            <button class="more-btn" id="reviewMoreBtn" style="display:none;">Îçî Î≥¥Í∏∞</button>
        </div>
    </div>

</div>
<div id="payment-overlay" style=" display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; "></div>

<script>
    // API URL ÏÑ§Ï†ï
    const API_URL = (() => {
        const hostname = window.location.hostname;

        if (hostname === 'localhost' || hostname === '127.0.0.1') {
            return 'http://localhost:8080';
        }

        if (hostname === 'admin.ssak3.store') {
            return 'https://admin.ssak3.store';
        }

        return 'https://ssak3.store';
    })();

    let page = 0;
    const size = 10;
    let hasNext = true;   // Ï≤´ Î°úÎìú Í∞ÄÎä•
    let isLoading = false;

    // ‚úÖ ÏßÄÍ∏àÍπåÏßÄ Î°úÎìúÌïú Ï£ºÎ¨∏(Ï†ÑÏ≤¥ Í∏∞Ï§Ä)
    const allOrders = [];

    // ‚úÖ ÏÑ†ÌÉùÎêú ÏÉÅÌÉúÎì§(ÌÜ†Í∏Ä ÌïÑÌÑ∞) - ÎπÑÏñ¥ÏûàÏúºÎ©¥ "Ï†ÑÏ≤¥"
    const selectedStatuses = new Set(); // 'PAYMENT_PENDING' | 'DONE' | 'CANCELED'

    async function applyHeaderAuthUI() {
        const loginBtn = document.getElementById('loginBtn');
        const userInfo = document.getElementById('userInfo');
        const token = localStorage.getItem('accessToken');
        try {
            const res = await fetch(`${API_URL}/ssak3/users/me`, {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Authorization': token ? `Bearer ${token}` : ''
                }
            });

            if (res.ok) {
                loginBtn.style.display = 'none';
                userInfo.style.display = 'flex';
            } else {
                loginBtn.style.display = 'inline-block';
                userInfo.style.display = 'none';
            }
        } catch {
            console.error('Ìó§Îçî Ïù∏Ï¶ù Ïã§Ìå®', e);
            loginBtn.style.display = 'inline-block';
            userInfo.style.display = 'none';
        }
    }

    function initHeaderActions() {
        document.getElementById('cartIconBtn').onclick = () => location.href = 'cart.html';
        document.getElementById('myPageBtn').onclick = () => location.href = 'mypage.html';
        document.getElementById('loginBtn').onclick = () => location.href = 'login.html';
        document.getElementById('logoutBtn').onclick = () => {
            localStorage.removeItem('accessToken');
            applyHeaderAuthUI();
            alert('Î°úÍ∑∏ÏïÑÏõÉ ÎêòÏóàÏäµÎãàÎã§.');
            location.href = 'home.html';
        };
    }

    async function apiFetch(path, options = {}) {
        const url = `${API_URL}/ssak3` + path;
        const token = localStorage.getItem('accessToken');

        if (token) {
            const res1 = await fetch(url, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    ...(options.headers || {}),
                    'Authorization': `Bearer ${token}`
                }
            });
            if (res1.status !== 401) return res1;
        }

        return fetch(url, {
            ...options,
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
                ...(options.headers || {})
            }
        });
    }

    function formatWon(n) {
        const num = Number(n || 0);
        return num.toLocaleString('ko-KR') + 'Ïõê';
    }

    function formatDateTime(v) {
        if (!v) return '-';
        try {
            const d = new Date(v);
            if (!Number.isNaN(d.getTime())) return d.toLocaleString('ko-KR');
            return String(v).replace('T', ' ');
        } catch {
            return String(v);
        }
    }

    function statusMeta(status) {
        const s = String(status || '');
        if (s === 'PAYMENT_PENDING') return { text: 'Í≤∞Ï†ú ÎåÄÍ∏∞', cls: 'pending' };
        if (s === 'DONE') return { text: 'Í≤∞Ï†ú ÏôÑÎ£å', cls: 'done' };
        if (s === 'CANCELED') return { text: 'Ï∑®ÏÜå', cls: 'canceled' };
        if (s === 'PAYMENT_FAILED') return { text: 'Í≤∞Ï†ú Ïã§Ìå®', cls: 'failed' };
        return { text: s || 'ÏÉÅÌÉú ÏóÜÏùå', cls: '' };
    }

    function renderEmpty(emoji, msg, submsg) {
        const listEl = document.getElementById('orderList');
        listEl.innerHTML = `
      <div class="empty">
        <div class="emoji">${emoji}</div>
        <div class="msg">${msg}</div>
        <div class="submsg">${submsg}</div>
      </div>
    `;
    }

    function buildOrderItem(o) {
        const orderId = o.orderId;
        const orderNo = o.orderNo; // ‚úÖ Ï∂îÍ∞Ä
        const totalPrice = o.totalPrice;
        const createdAt = o.createdAt;
        const st = statusMeta(o.orderStatus);

        const item = document.createElement('div');
        item.className = 'order-item';
        item.onclick = () => location.href = `order-detail.html?orderId=${encodeURIComponent(orderId)}`;

        const actionHtml = (String(o.orderStatus) === 'PAYMENT_PENDING')
            ? `
      <div class="btn-row">
        <button class="btn primary" data-action="retry">Ïû¨Í≤∞Ï†ú</button>
        <button class="btn danger" data-action="cancel">Ï£ºÎ¨∏ Ï∑®ÏÜå</button>
      </div>
    `
            : `<div class="btn-row"></div>`;

        // ‚úÖ ÌëúÏãúÏö© Ï£ºÎ¨∏Î≤àÌò∏: orderNo Ïö∞ÏÑ†, ÏóÜÏúºÎ©¥ orderIdÎ°ú fallback
        const displayOrderNo = (orderNo && String(orderNo).trim().length > 0)
            ? orderNo
            : orderId;

        item.innerHTML = `
    <div class="left">
      <div class="topline">
        <div class="order-no">Ï£ºÎ¨∏ #${displayOrderNo}</div> <!-- ‚úÖ Î≥ÄÍ≤Ω -->
        <span class="badge ${st.cls}">${st.text}</span>
      </div>
      <div class="price">${formatWon(totalPrice)}</div>
      <div class="muted">Ï£ºÎ¨∏Ïùº: ${formatDateTime(createdAt)}</div>
    </div>

    <div class="right">
      <div class="muted" style="text-align:right;">ÏÉÅÏÑ∏ Î≥¥Í∏∞ ‚Üí</div>
      ${actionHtml}
    </div>
  `;

        const retryBtn = item.querySelector('button[data-action="retry"]');
        const cancelBtn = item.querySelector('button[data-action="cancel"]');

        if (retryBtn) {
            retryBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                await retryPayment(orderId, retryBtn, cancelBtn);
            });
        }
        if (cancelBtn) {
            cancelBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                await cancelPending(orderId, retryBtn, cancelBtn);
            });
        }

        return item;
    }

    // ‚úÖ ÏÑ†ÌÉùÎêú ÏÉÅÌÉúÍ∞Ä ÏóÜÏúºÎ©¥ Ï†ÑÏ≤¥ / ÏûàÏúºÎ©¥ Í∑∏ ÏÉÅÌÉúÎì§Îßå Î≥¥Ïó¨Ï§å
    function getFilteredOrders() {
        if (selectedStatuses.size === 0) return allOrders;

        return allOrders.filter(o => selectedStatuses.has(String(o.orderStatus)));
    }

    function renderList() {
        const listEl = document.getElementById('orderList');
        listEl.innerHTML = '';

        const filtered = getFilteredOrders();

        if (filtered.length === 0) {
            if (allOrders.length === 0) {
                renderEmpty('üßæ', 'Ï£ºÎ¨∏ ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§', 'ÏÉÅÌíàÏùÑ Ï£ºÎ¨∏Ìï¥Î≥¥ÏÑ∏Ïöî!');
            } else if (hasNext) {
                renderEmpty('üîé', 'ÌëúÏãúÌï† Ï£ºÎ¨∏Ïù¥ ÏóÜÏäµÎãàÎã§', 'Îçî Î≥¥Í∏∞Î•º ÎàåÎü¨ Ï£ºÎ¨∏ÏùÑ Îçî Î∂àÎü¨ÏôÄÎ≥¥ÏÑ∏Ïöî.');
            } else {
                renderEmpty('üßæ', 'Ï£ºÎ¨∏ ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§', 'Ìï¥Îãπ Ï°∞Í±¥Ïùò Ï£ºÎ¨∏Ïù¥ ÏóÜÏñ¥Ïöî.');
            }
            return;
        }

        for (const o of filtered) listEl.appendChild(buildOrderItem(o));
    }

    function updateMoreBtn() {
        const moreBtn = document.getElementById('moreBtn');
        moreBtn.style.display = hasNext ? 'inline-flex' : 'none';
        moreBtn.disabled = isLoading;
    }

    // ‚úÖ Î≤ÑÌäº UI(active) ÎèôÍ∏∞Ìôî
    function syncFilterButtonsUI() {
        document.querySelectorAll('.filter-btn').forEach(btn => {
            const st = btn.dataset.status;
            btn.classList.toggle('active', selectedStatuses.has(st));
        });
    }

    // ‚úÖ ÌÜ†Í∏Ä ÌïÑÌÑ∞: Îã§Ïãú ÎàÑÎ•¥Î©¥ Ìï¥Ï†ú / Î™®Îëê Ìï¥Ï†úÎêòÎ©¥ ÏûêÎèôÏúºÎ°ú Ï†ÑÏ≤¥ ÌëúÏãú
    function toggleStatus(status) {
        if (selectedStatuses.has(status)) selectedStatuses.delete(status);
        else selectedStatuses.add(status);

        syncFilterButtonsUI();
        renderList();
    }

    async function loadNextPage() {
        if (isLoading) return;
        if (!hasNext && page !== 0) return;

        isLoading = true;
        updateMoreBtn();

        try {
            const res = await apiFetch(`/orders?page=${page}&size=${size}`, { method: 'GET' });
            if (!res.ok) {
                if (res.status === 401 || res.status === 403) {
                    alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                    location.href = 'login.html';
                    return;
                }
                const txt = await res.text().catch(() => '');
                throw new Error(txt || `Ï£ºÎ¨∏ Î™©Î°ù Ï°∞Ìöå Ïã§Ìå® (${res.status})`);
            }

            const json = await res.json();
            const data = json.data || {};
            const list = Array.isArray(data.content) ? data.content : [];

            allOrders.push(...list);

            const currentPage = Number(data.page);
            const totalPages = Number(data.totalPages);
            hasNext = (Number.isFinite(currentPage) && Number.isFinite(totalPages))
                ? (currentPage + 1 < totalPages)
                : false;

            page = Number.isFinite(currentPage) ? (currentPage + 1) : (page + 1);

            renderList();
        } catch (err) {
            console.error(err);
            alert('Ï£ºÎ¨∏ Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.');
        } finally {
            isLoading = false;
            updateMoreBtn();
        }
    }

    async function retryPayment(orderId, retryBtn, cancelBtn) {
        if (retryBtn) retryBtn.disabled = true;
        if (cancelBtn) cancelBtn.disabled = true;

        const overlay = document.getElementById('payment-overlay');

        try {
            const res = await apiFetch(`/orders/${orderId}/retry-payment`, { method: 'POST' });
            if (!res.ok) {
                const txt = await res.text().catch(() => '');
                throw new Error(txt || `Ïû¨Í≤∞Ï†ú Ïã§Ìå® (${res.status})`);
            }

            const json = await res.json();
            const url = json?.data?.paymentUrl;
            if (!url) throw new Error('Í≤∞Ï†ú URLÏù¥ ÏóÜÏäµÎãàÎã§.');

            // ‚úÖ Ïò§Î≤ÑÎ†àÏù¥ ÌëúÏãú
            overlay.style.display = 'block';

            // ‚úÖ Í≤∞Ï†úÏö© ÌåùÏóÖ ÎùÑÏö∞Í∏∞
            const width = 1100;
            const height = 700;
            const left = (window.innerWidth - width) / 2;
            const top = (window.innerHeight - height) / 2;

            const paymentWindow = window.open(
                url,
                'paymentPopup',
                `width=${width},height=${height},top=${top},left=${left},resizable=yes,scrollbars=yes`
            );

            if (!paymentWindow) {
                alert('ÌåùÏóÖÏù¥ Ï∞®Îã®ÎêòÏóàÏäµÎãàÎã§. Î∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                overlay.style.display = 'none';
                return;
            }

            // ‚úÖ ÌåùÏóÖ Îã´Ìûò Í∞êÏßÄ
            const timer = setInterval(() => {
                if (paymentWindow.closed) {
                    clearInterval(timer);
                    overlay.style.display = 'none';  // Ïò§Î≤ÑÎ†àÏù¥ Ïà®ÍπÄ
                    page = 0;
                    allOrders.length = 0;
                    loadNextPage();  // Ï£ºÎ¨∏ Î™©Î°ù Í∞±Ïã†
                }
            }, 500);
        } catch (err) {
            console.error(err);
            alert('Ïû¨Í≤∞Ï†ú ÏöîÏ≤≠Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            if (retryBtn) retryBtn.disabled = false;
            if (cancelBtn) cancelBtn.disabled = false;
            overlay.style.display = 'none';
        }
    }

    async function cancelPending(orderId, retryBtn, cancelBtn) {
        if (!confirm('Í≤∞Ï†ú ÎåÄÍ∏∞ Ï£ºÎ¨∏ÏùÑ Ï∑®ÏÜåÌï†ÍπåÏöî?')) return;

        if (retryBtn) retryBtn.disabled = true;
        if (cancelBtn) cancelBtn.disabled = true;

        try {
            const res = await apiFetch(`/orders/${orderId}/cancel-pending`, { method: 'PATCH' });
            if (!res.ok) {
                const txt = await res.text().catch(() => '');
                throw new Error(txt || `Ï∑®ÏÜå Ïã§Ìå® (${res.status})`);
            }

            // ‚úÖ ÌòÑÏû¨ÍπåÏßÄ Î°úÎìúÎêú Î™©Î°ùÏóêÏÑú Ï†úÍ±∞ ÌõÑ Îã§Ïãú Î†åÎçî
            const idx = allOrders.findIndex(o => Number(o.orderId) === Number(orderId));
            if (idx >= 0) allOrders.splice(idx, 1);
            renderList();
        } catch (err) {
            console.error(err);
            alert('Ï£ºÎ¨∏ Ï∑®ÏÜåÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            if (retryBtn) retryBtn.disabled = false;
            if (cancelBtn) cancelBtn.disabled = false;
        }
    }

    function initFilterButtons() {
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => toggleStatus(btn.dataset.status));
        });
    }

    /* ===== ÌÉ≠ Ï†ÑÌôò ===== */
    function switchTab(tab) {
        const isOrders = tab === 'orders';
        document.getElementById('segOrders').classList.toggle('active', isOrders);
        document.getElementById('segReviews').classList.toggle('active', !isOrders);
        document.getElementById('sectionOrders').style.display = isOrders ? '' : 'none';
        document.getElementById('sectionReviews').style.display = isOrders ? 'none' : '';

        if (!isOrders && !reviewLoaded) {
            loadNextReviewPage();
        }
    }

    /* ===== Î¶¨Î∑∞ Í¥ÄÎ†® Î≥ÄÏàò ===== */
    let reviewPage = 0;
    const reviewSize = 10;
    let reviewHasNext = true;
    let reviewIsLoading = false;
    let reviewLoaded = false;

    // ÏÉÅÌíàÎ™Ö Ï∫êÏãú (productId ‚Üí productName)
    const productNameCache = {};

    async function fetchProductName(productId) {
        if (productNameCache[productId] !== undefined) return productNameCache[productId];
        try {
            const res = await apiFetch(`/products/${productId}`, { method: 'GET' });
            if (!res.ok) throw new Error();
            const json = await res.json();
            const name = json?.data?.name || json?.data?.productName || `ÏÉÅÌíà #${productId}`;
            productNameCache[productId] = name;
            return name;
        } catch {
            productNameCache[productId] = `ÏÉÅÌíà #${productId}`;
            return productNameCache[productId];
        }
    }

    function renderStars(score) {
        const n = Math.max(0, Math.min(5, Number(score) || 0));
        return '‚≠ê'.repeat(n);
    }

    function renderEmptyReview(emoji, msg, submsg) {
        document.getElementById('reviewList').innerHTML = `
          <div class="empty">
            <div class="emoji">${emoji}</div>
            <div class="msg">${msg}</div>
            <div class="submsg">${submsg}</div>
          </div>`;
    }

    async function buildReviewItem(r) {
        const productName = await fetchProductName(r.productId);
        const div = document.createElement('div');
        div.className = 'review-item';
        div.innerHTML = `
          <div class="review-topline">
            <span class="review-product-name">${productName}</span>
            <span class="review-stars">${renderStars(r.score)}</span>
          </div>
          <div class="review-content">${r.content || ''}</div>
          <div class="review-footer">
            <span class="review-date">ÏûëÏÑ±Ïùº: ${formatDateTime(r.createdAt)}</span>
            <button class="review-delete-btn" data-review-id="${r.id}">ÏÇ≠Ï†ú</button>
          </div>`;

        div.querySelector('.review-delete-btn').addEventListener('click', async (e) => {
            await deleteReview(r.id, e.currentTarget, div);
        });

        return div;
    }

    async function deleteReview(reviewId, btn, itemEl) {
        if (!confirm('Î¶¨Î∑∞Î•º ÏÇ≠Ï†úÌï†ÍπåÏöî?')) return;

        btn.disabled = true;
        try {
            const res = await apiFetch(`/reviews/${reviewId}`, { method: 'DELETE' });
            if (!res.ok) {
                const txt = await res.text().catch(() => '');
                throw new Error(txt || `ÏÇ≠Ï†ú Ïã§Ìå® (${res.status})`);
            }
            itemEl.remove();

            // Î¶¨Î∑∞Í∞Ä Î™®Îëê ÏÇ≠Ï†úÎêêÏúºÎ©¥ Îπà ÏÉÅÌÉú ÌëúÏãú
            const listEl = document.getElementById('reviewList');
            if (listEl.querySelectorAll('.review-item').length === 0) {
                renderEmptyReview('üí¨', 'ÏûëÏÑ±Ìïú Î¶¨Î∑∞Í∞Ä ÏóÜÏäµÎãàÎã§', 'ÏÉÅÌíàÏùÑ Íµ¨Îß§ÌïòÍ≥† Î¶¨Î∑∞Î•º ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî!');
            }
        } catch (err) {
            console.error(err);
            alert('Î¶¨Î∑∞ ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            btn.disabled = false;
        }
    }

    async function loadNextReviewPage() {
        if (reviewIsLoading) return;
        if (!reviewHasNext && reviewPage !== 0) return;

        reviewIsLoading = true;
        const moreBtn = document.getElementById('reviewMoreBtn');
        moreBtn.disabled = true;

        try {
            const res = await apiFetch(`/reviews/me?page=${reviewPage}&size=${reviewSize}`, { method: 'GET' });
            if (!res.ok) {
                if (res.status === 401 || res.status === 403) {
                    alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                    location.href = 'login.html';
                    return;
                }
                const txt = await res.text().catch(() => '');
                throw new Error(txt || `Î¶¨Î∑∞ Î™©Î°ù Ï°∞Ìöå Ïã§Ìå® (${res.status})`);
            }

            const json = await res.json();
            const data = json.data || {};
            const list = Array.isArray(data.content) ? data.content : [];

            const listEl = document.getElementById('reviewList');
            if (reviewPage === 0) listEl.innerHTML = '';

            if (list.length === 0 && reviewPage === 0) {
                renderEmptyReview('üí¨', 'ÏûëÏÑ±Ìïú Î¶¨Î∑∞Í∞Ä ÏóÜÏäµÎãàÎã§', 'ÏÉÅÌíàÏùÑ Íµ¨Îß§ÌïòÍ≥† Î¶¨Î∑∞Î•º ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî!');
            } else {
                for (const r of list) {
                    const item = await buildReviewItem(r);
                    listEl.appendChild(item);
                }
            }

            const currentPage = Number(data.page ?? data.number ?? reviewPage);
            const totalPages = Number(data.totalPages);
            reviewHasNext = (Number.isFinite(currentPage) && Number.isFinite(totalPages))
                ? (currentPage + 1 < totalPages)
                : false;
            reviewPage = currentPage + 1;
            reviewLoaded = true;

            moreBtn.style.display = reviewHasNext ? 'inline-flex' : 'none';
        } catch (err) {
            console.error(err);
            renderEmptyReview('‚ö†Ô∏è', 'Î¶¨Î∑∞Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§', 'Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
        } finally {
            reviewIsLoading = false;
            moreBtn.disabled = false;
        }
    }

    (async function init() {
        applyHeaderAuthUI();
        initHeaderActions();
        initFilterButtons();

        // ‚úÖ Í∏∞Î≥∏ÏùÄ Ï†ÑÏ≤¥(ÏÑ†ÌÉù ÏóÜÏùå)
        syncFilterButtonsUI();

        // ‚úÖ Ï≤´ ÌéòÏù¥ÏßÄ Î°úÎìú
        await loadNextPage();

        document.getElementById('moreBtn').addEventListener('click', loadNextPage);
        document.getElementById('reviewMoreBtn').addEventListener('click', loadNextReviewPage);
    })();
</script>
</body>
</html>
